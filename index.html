<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ThemeLens — Qualitative Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #111213;
  --sidebar-bg: #0d0e0f;
  --surface: #18191b;
  --surface2: #1f2022;
  --surface3: #252729;
  --border: #2c2e30;
  --border2: #363a3c;
  --accent: #e8c547;
  --accent2: #47b8e8;
  --accent3: #e84778;
  --accent4: #47e8a0;
  --text: #dde0e2;
  --text-muted: #7a8285;
  --text-dim: #404548;
  --font-display: 'Lora', serif;
  --font-mono: 'IBM Plex Mono', monospace;
  --font-body: 'IBM Plex Sans', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);font-weight:300;font-size:14px;display:flex;flex-direction:column}

/* ── AUTH SCREEN ── */
#auth-screen{display:flex;flex:1;align-items:center;justify-content:center;flex-direction:column;gap:0;background:var(--bg);position:relative;overflow:hidden}
#auth-screen::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(232,197,71,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(232,197,71,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.auth-card{background:var(--surface);border:1px solid var(--border);padding:48px;width:440px;max-width:90vw;position:relative;z-index:1;animation:fadeUp 0.4s ease}
.auth-logo{font-family:var(--font-display);font-size:2rem;font-weight:600;color:var(--text);margin-bottom:6px}
.auth-logo span{color:var(--accent)}
.auth-tagline{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:36px}
.auth-step{margin-bottom:28px}
.auth-step-num{font-family:var(--font-mono);font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:6px}
.auth-step-title{font-size:0.9rem;font-weight:500;color:var(--text);margin-bottom:4px}
.auth-step-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.6}
.auth-step-desc a{color:var(--accent2);text-decoration:none}
.auth-step-desc a:hover{text-decoration:underline}
.auth-divider{border:none;border-top:1px solid var(--border);margin:28px 0}
.btn-google{width:100%;background:var(--surface2);border:1px solid var(--border2);color:var(--text);font-family:var(--font-mono);font-size:0.75rem;letter-spacing:0.08em;padding:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.15s}
.btn-google:hover{border-color:var(--accent);background:var(--surface3)}
.google-icon{width:18px;height:18px;flex-shrink:0}
.auth-note{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);text-align:center;margin-top:16px;line-height:1.7}

/* ── ONBOARDING (after login, before API key) ── */
#onboarding-screen{display:none;flex:1;align-items:center;justify-content:center;flex-direction:column;background:var(--bg);position:relative;overflow:hidden}
#onboarding-screen::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(232,197,71,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(232,197,71,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}
.onboard-card{background:var(--surface);border:1px solid var(--border);padding:48px;width:520px;max-width:90vw;position:relative;z-index:1;animation:fadeUp 0.4s ease}
.onboard-title{font-family:var(--font-display);font-size:1.5rem;font-weight:600;color:var(--text);margin-bottom:6px}
.onboard-sub{font-size:0.82rem;color:var(--text-muted);line-height:1.6;margin-bottom:28px}
.onboard-steps{display:flex;flex-direction:column;gap:16px;margin-bottom:28px}
.onboard-step{display:flex;gap:14px;align-items:flex-start;padding:14px;background:var(--surface2);border:1px solid var(--border)}
.onboard-step-num{font-family:var(--font-display);font-size:1.4rem;font-weight:600;color:var(--accent);line-height:1;flex-shrink:0;width:28px}
.onboard-step-content{}
.onboard-step-title{font-size:0.82rem;font-weight:500;color:var(--text);margin-bottom:3px}
.onboard-step-desc{font-size:0.75rem;color:var(--text-muted);line-height:1.55}
.onboard-step-desc a{color:var(--accent2);text-decoration:none}
.onboard-step-desc a:hover{text-decoration:underline}
.onboard-input-row{display:flex;gap:8px;margin-top:28px}
#onboard-key-input{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:0.8rem;padding:12px;outline:none;transition:border-color 0.15s}
#onboard-key-input:focus{border-color:var(--accent)}
#onboard-key-input::placeholder{color:var(--text-dim)}
.btn-primary{background:var(--accent);color:#111;border:none;font-family:var(--font-mono);font-size:0.72rem;font-weight:500;letter-spacing:0.08em;padding:12px 24px;cursor:pointer;transition:all 0.15s;white-space:nowrap}
.btn-primary:hover{background:#f0d060;transform:translateY(-1px)}
.err-msg{background:rgba(232,71,120,0.08);border:1px solid rgba(232,71,120,0.25);border-left:3px solid var(--accent3);padding:10px 14px;font-family:var(--font-mono);font-size:0.7rem;color:var(--accent3);margin-top:10px;display:none;line-height:1.6}
.err-msg.visible{display:block}

/* ── TOPBAR ── */
#topbar{height:48px;background:var(--sidebar-bg);border-bottom:1px solid var(--border);display:none;align-items:center;padding:0 16px;gap:16px;flex-shrink:0;z-index:100}
.logo-mark{font-family:var(--font-display);font-size:1.1rem;font-weight:600;color:var(--text);letter-spacing:-0.01em}
.logo-mark span{color:var(--accent)}
.topbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.topbar-btn{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);background:none;border:1px solid var(--border);padding:5px 12px;cursor:pointer;transition:all 0.15s}
.topbar-btn:hover{border-color:var(--accent);color:var(--accent)}
.topbar-btn.primary{background:var(--accent);color:#111;border-color:var(--accent);font-weight:500}
.topbar-btn.primary:hover{background:#f0d060}
#user-info{margin-left:auto;display:flex;align-items:center;gap:10px}
#user-email{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim)}
#api-indicator{display:flex;align-items:center;gap:5px;cursor:pointer;padding:4px 8px;border:1px solid var(--border);transition:border-color 0.15s}
#api-indicator:hover{border-color:var(--accent)}
#api-dot{width:6px;height:6px;border-radius:50%;background:var(--accent4)}
#api-indicator-text{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim)}
.btn-signout{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);background:none;border:1px solid var(--border);padding:4px 10px;cursor:pointer;transition:all 0.15s}
.btn-signout:hover{border-color:var(--accent3);color:var(--accent3)}

/* ── LAYOUT ── */
#app{display:none;flex:1;overflow:hidden}

/* ── LEFT SIDEBAR ── */
#sidebar{width:240px;background:var(--sidebar-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-title{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted)}
.icon-btn{width:24px;height:24px;background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
#projects-list{flex:1;overflow-y:auto;padding:8px}
.project-item{padding:10px 12px;cursor:pointer;border:1px solid transparent;margin-bottom:2px;transition:all 0.15s;border-radius:2px}
.project-item:hover{background:var(--surface);border-color:var(--border)}
.project-item.active{background:var(--surface);border-color:var(--accent)}
.proj-name{font-size:0.82rem;font-weight:400;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.proj-meta{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);display:flex;gap:8px;align-items:center}
.proj-badge{padding:1px 5px;border-radius:2px;font-size:0.58rem}
.proj-badge.active{background:rgba(72,184,232,0.15);color:var(--accent2)}
.proj-badge.archived{background:rgba(100,100,100,0.15);color:var(--text-dim)}
.empty-state{padding:24px 12px;text-align:center;font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);line-height:1.8}

/* ── MAIN ── */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#welcome{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:48px}
.welcome-title{font-family:var(--font-display);font-size:2rem;font-weight:600;color:var(--text);text-align:center}
.welcome-sub{font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);letter-spacing:0.1em;text-align:center;line-height:1.8}

/* PROJECT VIEW */
#project-view{flex:1;display:none;flex-direction:column;overflow:hidden}
#project-topbar{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-shrink:0}
.project-title-area{flex:1}
#proj-title{font-family:var(--font-display);font-size:1.4rem;font-weight:600;color:var(--text);margin-bottom:4px}
#proj-desc{font-size:0.8rem;color:var(--text-muted);font-weight:300}
.project-actions{display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}

/* TABS */
#proj-tabs{padding:0 24px;border-bottom:1px solid var(--border);display:flex;gap:0;flex-shrink:0}
.proj-tab{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;padding:12px 16px;cursor:pointer;color:var(--text-muted);border-bottom:2px solid transparent;transition:all 0.15s;background:none;border-top:none;border-left:none;border-right:none}
.proj-tab:hover{color:var(--text)}
.proj-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

#tab-content{flex:1;overflow:hidden;display:flex}

/* DOCUMENTS */
#tab-documents{flex:1;overflow-y:auto;padding:24px;display:none}
#tab-documents.active{display:block}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-label{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted)}
.docs-table{width:100%;border-collapse:collapse}
.docs-table th{font-family:var(--font-mono);font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);padding:8px 12px;text-align:left;border-bottom:1px solid var(--border)}
.docs-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:0.82rem;vertical-align:middle}
.docs-table tr:hover td{background:var(--surface)}
.doc-source{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-muted);padding:2px 6px;background:var(--surface2);border:1px solid var(--border)}
.doc-date{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim)}
.doc-actions{display:flex;gap:6px}
.small-btn{font-family:var(--font-mono);font-size:0.6rem;padding:4px 8px;background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all 0.12s}
.small-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.small-btn.danger:hover{border-color:var(--accent3);color:var(--accent3)}

/* ANALYSIS */
#tab-analysis{flex:1;overflow-y:auto;padding:24px;display:none}
#tab-analysis.active{display:block}
.method-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.method-card{border:1px solid var(--border);padding:14px 16px;cursor:pointer;transition:all 0.15s;background:var(--surface)}
.method-card:hover{border-color:var(--accent);background:var(--surface2)}
.method-card.selected{border-color:var(--accent);background:rgba(232,197,71,0.06)}
.method-card.selected .method-name{color:var(--accent)}
.method-tag{font-family:var(--font-mono);font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}
.method-name{font-size:0.85rem;font-weight:500;color:var(--text);margin-bottom:4px}
.method-desc{font-size:0.72rem;color:var(--text-muted);line-height:1.55}
.method-check{display:none;font-family:var(--font-mono);font-size:0.6rem;color:var(--accent);margin-top:8px}
.method-card.selected .method-check{display:block}
.options-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.opt-group{display:flex;flex-direction:column;gap:6px}
.opt-label{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted)}
select,input[type=text],input[type=password],textarea{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:0.78rem;padding:8px 12px;outline:none;width:100%;transition:border-color 0.15s}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%237a8285'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer}
select:focus,input:focus,textarea:focus{border-color:var(--accent)}
#deductive-panel{display:none;margin-bottom:24px;border:1px solid var(--border);padding:16px;background:var(--surface)}
.deductive-header{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent2);margin-bottom:10px}
#categories-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;min-height:28px}
.category-tag{background:rgba(71,184,232,0.1);border:1px solid rgba(71,184,232,0.3);color:var(--accent2);font-family:var(--font-mono);font-size:0.65rem;padding:3px 8px;display:flex;align-items:center;gap:6px}
.category-tag button{background:none;border:none;color:var(--accent2);cursor:pointer;font-size:0.7rem;opacity:0.6;padding:0}
.category-tag button:hover{opacity:1}
.add-cat-row{display:flex;gap:8px}
.run-bar{display:flex;align-items:center;gap:16px;padding:16px 0;border-top:1px solid var(--border);margin-top:8px}
.btn-run{font-family:var(--font-display);font-size:0.95rem;font-weight:600;background:var(--accent);color:#111;border:none;padding:12px 36px;cursor:pointer;transition:all 0.2s}
.btn-run:hover:not(:disabled){background:#f0d060;transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,197,71,0.25)}
.btn-run:disabled{opacity:0.35;cursor:not-allowed}
.run-note{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);line-height:1.7}
.runs-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--border)}
.run-item{border:1px solid var(--border);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:16px;background:var(--surface);transition:border-color 0.15s;cursor:pointer}
.run-item:hover{border-color:var(--accent2)}
.run-item.selected-run{border-color:var(--accent)}
.run-number{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);width:56px;flex-shrink:0}
.run-info{flex:1}
.run-method{font-size:0.82rem;font-weight:400;color:var(--text);margin-bottom:2px}
.run-meta{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim)}
.run-status{font-family:var(--font-mono);font-size:0.58rem;padding:3px 8px;border-radius:2px}
.run-status.complete{background:rgba(71,232,160,0.1);color:var(--accent4)}
.run-actions{display:flex;gap:6px}

/* RESULTS */
#tab-results{flex:1;overflow:hidden;display:none;flex-direction:row}
#tab-results.active{display:flex}
#results-main{flex:1;overflow-y:auto;padding:24px}
.result-summary{background:var(--surface);border-left:3px solid var(--accent2);padding:14px 18px;margin-bottom:24px;font-size:0.85rem;line-height:1.7;color:var(--text-muted)}
.results-stats{display:flex;gap:24px;margin-bottom:24px}
.stat-item{text-align:center}
.stat-val{font-family:var(--font-display);font-size:1.8rem;font-weight:600;color:var(--accent);line-height:1}
.stat-lbl{font-family:var(--font-mono);font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-top:4px}
.theme-card{border:1px solid var(--border);margin-bottom:16px;background:var(--surface);overflow:hidden;transition:border-color 0.15s}
.theme-card:hover{border-color:var(--border2)}
.theme-card.highlighted{border-color:var(--accent)}
.theme-hdr{padding:16px 20px;cursor:pointer;display:flex;align-items:flex-start;gap:14px;user-select:none}
.theme-hdr:hover{background:rgba(232,197,71,0.03)}
.theme-num{font-family:var(--font-display);font-size:2.2rem;font-weight:600;color:var(--text-dim);line-height:1;flex-shrink:0;width:44px}
.theme-info{flex:1}
.theme-name{font-family:var(--font-display);font-size:1.05rem;font-weight:600;color:var(--text);margin-bottom:4px}
.theme-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.6}
.theme-chevron{font-size:0.7rem;color:var(--text-dim);flex-shrink:0;padding-top:4px;transition:transform 0.2s}
.theme-chevron.open{transform:rotate(180deg)}
.theme-body{display:none;border-top:1px solid var(--border);padding:0 20px 20px}
.theme-body.open{display:block}
.subtheme{margin-top:16px;padding-left:16px;border-left:2px solid var(--accent2)}
.sub-name{font-family:var(--font-mono);font-size:0.72rem;font-weight:500;color:var(--accent2);margin-bottom:4px}
.sub-id{font-size:0.58rem;color:var(--text-dim);margin-right:6px}
.sub-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.6;margin-bottom:10px}
.code-block{background:var(--surface2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;cursor:pointer;transition:border-color 0.15s}
.code-block:hover{border-color:var(--accent3)}
.code-block.open{border-color:var(--accent3)}
.code-top{display:flex;align-items:flex-start;gap:8px;margin-bottom:4px}
.code-id-lbl{font-family:var(--font-mono);font-size:0.58rem;color:var(--text-dim);flex-shrink:0;padding-top:1px}
.code-label{font-family:var(--font-mono);font-size:0.72rem;font-weight:500;color:var(--accent3)}
.code-desc{font-size:0.75rem;color:var(--text-muted);line-height:1.55;padding-left:36px;margin-bottom:6px}
.excerpts-wrap{display:none;padding-left:36px}
.excerpts-wrap.open{display:block}
.excerpt-item{border-left:2px solid rgba(232,71,120,0.4);padding:8px 12px;margin:6px 0;background:rgba(232,71,120,0.04)}
.excerpt-quote{font-family:var(--font-display);font-size:0.85rem;font-style:italic;color:var(--text);line-height:1.65;margin-bottom:4px}
.excerpt-rel{font-size:0.7rem;color:var(--text-dim);line-height:1.5}
.excerpts-toggle{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);letter-spacing:0.08em;padding-left:36px;margin-top:2px}
.excerpts-toggle:hover{color:var(--accent3)}
.memo-card{border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px 20px;margin-top:24px;background:var(--surface)}
.memo-lbl{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.memo-text{font-size:0.82rem;color:var(--text-muted);line-height:1.7}

/* RESULTS SIDEBAR */
#results-sidebar{width:260px;border-left:1px solid var(--border);background:var(--sidebar-bg);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.rs-header{padding:14px 16px;border-bottom:1px solid var(--border)}
.rs-title{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px}
#rs-search{font-size:0.75rem;padding:7px 10px}
.rs-filters{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;gap:6px}
.rs-filter{font-family:var(--font-mono);font-size:0.6rem;padding:4px 8px;border:1px solid var(--border);background:none;color:var(--text-muted);cursor:pointer;transition:all 0.12s}
.rs-filter.active{background:var(--accent);color:#111;border-color:var(--accent)}
#rs-list{flex:1;overflow-y:auto;padding:8px}
.rs-item{padding:10px 12px;border:1px solid transparent;margin-bottom:2px;cursor:pointer;transition:all 0.12s}
.rs-item:hover{background:var(--surface);border-color:var(--border)}
.rs-item-theme{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);margin-bottom:3px}
.rs-item-name{font-size:0.78rem;color:var(--text);margin-bottom:4px}
.rs-item-excerpt{font-size:0.7rem;color:var(--text-muted);line-height:1.5;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* NOTES */
#tab-notes{flex:1;overflow-y:auto;padding:24px;display:none;flex-direction:column;gap:16px}
#tab-notes.active{display:flex}
#notes-area{flex:1;min-height:300px;resize:none;font-family:var(--font-body);font-size:0.85rem;font-weight:300;line-height:1.8;padding:16px}
.notes-footer{display:flex;justify-content:space-between;align-items:center}
.notes-saved{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim)}

/* EXPORT BAR */
.export-bar{padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap;background:var(--sidebar-bg)}

/* LOADING */
#loading-overlay{display:none;position:fixed;inset:0;background:rgba(13,14,15,0.92);z-index:1000;align-items:center;justify-content:center;flex-direction:column;gap:20px}
#loading-overlay.visible{display:flex}
.spinner{width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-msg{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);letter-spacing:0.1em;text-align:center}
.loading-steps{display:flex;flex-direction:column;gap:5px;align-items:center}
.lstep{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);transition:color 0.3s}
.lstep.active{color:var(--accent)}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;align-items:center;justify-content:center}
.modal-overlay.visible{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);padding:28px;width:480px;max-width:90vw;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--font-display);font-size:1.2rem;font-weight:600;margin-bottom:20px;color:var(--text)}
.form-row{margin-bottom:14px}
.form-label{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;display:block}
textarea.form-input{min-height:80px;resize:vertical;font-family:var(--font-body);font-size:0.82rem}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.btn-cancel{font-family:var(--font-mono);font-size:0.65rem;background:none;border:1px solid var(--border);color:var(--text-muted);padding:8px 16px;cursor:pointer}
.btn-cancel:hover{border-color:var(--accent3);color:var(--accent3)}
.btn-confirm{font-family:var(--font-mono);font-size:0.65rem;background:var(--accent);color:#111;border:none;padding:8px 20px;cursor:pointer;font-weight:500}
.btn-confirm:hover{background:#f0d060}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp 0.3s ease forwards}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border)}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}
</style>
</head>
<body>

<!-- ── AUTH SCREEN ── -->
<div id="auth-screen" style="display:flex;flex:1">
  <div class="auth-card">
    <div class="auth-logo">Theme<span>Lens</span></div>
    <div class="auth-tagline">Qualitative Analysis · Powered by AI</div>

    <div class="auth-step">
      <div class="auth-step-num">What is ThemeLens?</div>
      <div class="auth-step-title">A lite qualitative research tool</div>
      <div class="auth-step-desc">Perform Thematic Analysis, Content Analysis, and Narrative Analysis on your research data. Projects are saved to the cloud — access them from any device.</div>
    </div>

    <div class="auth-step">
      <div class="auth-step-num">How does it work?</div>
      <div class="auth-step-title">Sign in → Add your Gemini key → Analyse</div>
      <div class="auth-step-desc">ThemeLens uses Google's <a href="https://aistudio.google.com" target="_blank">Gemini API</a> to run analyses. You'll need a free API key (takes 2 minutes to get). Your key is stored securely in your account — enter it once, use it forever.</div>
    </div>

    <hr class="auth-divider">

    <button class="btn-google" onclick="signInWithGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
    <div class="auth-note">Your research data is private. Row-level security ensures only you can access your projects.</div>
  </div>
</div>

<!-- ── ONBOARDING (API KEY) ── -->
<div id="onboarding-screen">
  <div class="onboard-card">
    <div class="auth-logo" style="margin-bottom:6px">Theme<span style="color:var(--accent)">Lens</span></div>
    <div class="onboard-title" style="margin-top:20px">One last step</div>
    <div class="onboard-sub">ThemeLens needs a free Gemini API key to run analyses. You only do this once.</div>
    <div class="onboard-steps">
      <div class="onboard-step">
        <div class="onboard-step-num">1</div>
        <div class="onboard-step-content">
          <div class="onboard-step-title">Go to Google AI Studio</div>
          <div class="onboard-step-desc">Visit <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a> — you're already signed in with your Google account.</div>
        </div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">2</div>
        <div class="onboard-step-content">
          <div class="onboard-step-title">Click "Get API Key"</div>
          <div class="onboard-step-desc">Click the button in the top-left corner. Then click "Create API key". Copy the key that appears.</div>
        </div>
      </div>
      <div class="onboard-step">
        <div class="onboard-step-num">3</div>
        <div class="onboard-step-content">
          <div class="onboard-step-title">Paste it below</div>
          <div class="onboard-step-desc">Your key is stored securely in your account. It's used only to call the Gemini API on your behalf.</div>
        </div>
      </div>
    </div>
    <div class="onboard-input-row">
      <input type="password" id="onboard-key-input" placeholder="AIza...">
      <button class="btn-primary" onclick="saveOnboardKey()">Save & Enter</button>
    </div>
    <div class="err-msg" id="onboard-err"></div>
  </div>
</div>

<!-- ── TOPBAR ── -->
<div id="topbar">
  <div class="logo-mark">Theme<span>Lens</span></div>
  <div class="topbar-sep"></div>
  <button class="topbar-btn primary" onclick="openNewProject()">+ New Project</button>
  <div id="user-info">
    <div id="api-indicator" onclick="openApiModal()" title="Change API key">
      <div id="api-dot"></div>
      <span id="api-indicator-text">Gemini ready</span>
    </div>
    <span id="user-email"></span>
    <button class="btn-signout" onclick="signOut()">Sign out</button>
  </div>
</div>

<!-- ── APP ── -->
<div id="app">
  <div id="sidebar">
    <div id="sidebar-header">
      <span class="sidebar-title">Projects</span>
      <button class="icon-btn" onclick="openNewProject()">+</button>
    </div>
    <div id="projects-list">
      <div class="empty-state" id="empty-projects">No projects yet.<br>Create one to begin.</div>
    </div>
  </div>

  <div id="main">
    <div id="welcome">
      <div class="welcome-title">Welcome to ThemeLens</div>
      <div class="welcome-sub">Create a project to begin your qualitative analysis.</div>
      <button class="topbar-btn primary" style="margin-top:8px" onclick="openNewProject()">+ Create your first project</button>
    </div>

    <div id="project-view">
      <div id="project-topbar">
        <div class="project-title-area">
          <div id="proj-title"></div>
          <div id="proj-desc"></div>
        </div>
        <div class="project-actions">
          <button class="topbar-btn" onclick="editProject()">Edit</button>
          <button class="topbar-btn" onclick="archiveProject()">Archive</button>
          <button class="topbar-btn" style="color:var(--accent3);border-color:var(--accent3)" onclick="deleteProject()">Delete</button>
        </div>
      </div>
      <div id="proj-tabs">
        <button class="proj-tab active" onclick="switchTab('documents')">Documents</button>
        <button class="proj-tab" onclick="switchTab('analysis')">Analysis</button>
        <button class="proj-tab" onclick="switchTab('results')">Results</button>
        <button class="proj-tab" onclick="switchTab('notes')">Researcher Notes</button>
      </div>
      <div id="tab-content">

        <!-- DOCUMENTS -->
        <div id="tab-documents" class="active">
          <div class="section-header">
            <span class="section-label">Documents</span>
            <button class="topbar-btn primary" onclick="openAddDoc()">+ Add Document</button>
          </div>
          <table class="docs-table" id="docs-table" style="display:none">
            <thead><tr><th>Title</th><th>Source Type</th><th>Added</th><th>Actions</th></tr></thead>
            <tbody id="docs-tbody"></tbody>
          </table>
          <div id="no-docs" class="empty-state" style="text-align:left;padding:24px 0">No documents yet.</div>
        </div>

        <!-- ANALYSIS -->
        <div id="tab-analysis">
          <div class="section-label" style="margin-bottom:16px">Select Methodology</div>
          <div class="method-grid">
            <div class="method-card selected" data-method="reflexive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Reflexive TA</div>
              <div class="method-desc">Braun & Clarke (2022). Researcher-driven, iterative construction of themes.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="inductive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Inductive TA</div>
              <div class="method-desc">Bottom-up. Themes emerge entirely from data without theoretical preconceptions.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="deductive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Deductive TA</div>
              <div class="method-desc">Top-down. Analysis guided by predefined theoretical categories.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="framework_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Framework Analysis</div>
              <div class="method-desc">Structured, matrix-based approach common in applied/policy research.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="content_analysis" onclick="selectMethod(this)">
              <div class="method-tag">Content Analysis</div>
              <div class="method-name">Content Analysis</div>
              <div class="method-desc">Bardin (1977). Systematic categorisation and quantification of content.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="narrative" onclick="selectMethod(this)">
              <div class="method-tag">Narrative Analysis</div>
              <div class="method-name">Narrative Analysis</div>
              <div class="method-desc">Preserves story structure. Analyses narrative construction and identity.</div>
              <div class="method-check">✓ Selected</div>
            </div>
          </div>

          <div id="deductive-panel">
            <div class="deductive-header">Predefined Categories / Theoretical Framework</div>
            <div id="categories-list"></div>
            <div class="add-cat-row">
              <input type="text" id="catInput" placeholder="Add a category (press Enter)..." onkeydown="if(event.key==='Enter')addCategory()">
              <button class="topbar-btn" onclick="addCategory()">Add</button>
            </div>
          </div>

          <div class="section-label" style="margin-bottom:12px">Analysis Options</div>
          <div class="options-grid">
            <div class="opt-group">
              <label class="opt-label">Output Language</label>
              <select id="opt-lang">
                <option value="English">English</option>
                <option value="European Portuguese">Português</option>
                <option value="Spanish">Español</option>
              </select>
            </div>
            <div class="opt-group">
              <label class="opt-label">Depth</label>
              <select id="opt-depth">
                <option value="standard">Standard</option>
                <option value="detailed">Detailed</option>
                <option value="brief">Brief / Overview</option>
              </select>
            </div>
          </div>

          <div class="err-msg" id="analysis-err"></div>
          <div class="run-bar">
            <button class="btn-run" id="run-btn" onclick="runAnalysis()">Run Analysis</button>
            <div class="run-note">Results are saved to your account<br>and accessible from any device.</div>
          </div>

          <div class="runs-section">
            <div class="section-label" style="margin-bottom:12px">Analysis Runs</div>
            <div id="runs-list"></div>
            <div id="no-runs" class="empty-state" style="text-align:left;padding:12px 0">No runs yet.</div>
          </div>
        </div>

        <!-- RESULTS -->
        <div id="tab-results">
          <div id="results-main">
            <div id="no-results" class="empty-state">No results yet. Run an analysis first.</div>
            <div id="results-content" style="display:none"></div>
          </div>
          <div id="results-sidebar">
            <div class="rs-header">
              <div class="rs-title">Themes & Codes</div>
              <input type="text" id="rs-search" placeholder="Search excerpts..." oninput="filterResults()">
            </div>
            <div class="rs-filters">
              <button class="rs-filter active" data-filter="all" onclick="setRsFilter(this)">All</button>
              <button class="rs-filter" data-filter="themes" onclick="setRsFilter(this)">Themes</button>
              <button class="rs-filter" data-filter="codes" onclick="setRsFilter(this)">Codes</button>
            </div>
            <div id="rs-list"></div>
          </div>
        </div>

        <!-- NOTES -->
        <div id="tab-notes">
          <div class="section-label">Researcher Notes & Reflexive Memo</div>
          <textarea id="notes-area" placeholder="Record your reflexive memos, analytical decisions, and observations here..."></textarea>
          <div class="notes-footer">
            <span class="notes-saved" id="notes-saved"></span>
            <button class="topbar-btn" onclick="saveNotes()">Save Notes</button>
          </div>
        </div>

      </div><!-- /tab-content -->

      <div class="export-bar" id="export-bar" style="display:none">
        <button class="topbar-btn" onclick="exportTXT()">Export TXT</button>
        <button class="topbar-btn" onclick="exportCSV()">Export CSV</button>
        <button class="topbar-btn" onclick="exportJSON()">Export JSON</button>
      </div>
    </div><!-- /project-view -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- LOADING -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-msg" id="loading-msg">Running analysis...</div>
  <div class="loading-steps">
    <div class="lstep" id="ls1">↳ Familiarisation with data</div>
    <div class="lstep" id="ls2">↳ Initial code generation</div>
    <div class="lstep" id="ls3">↳ Searching for themes</div>
    <div class="lstep" id="ls4">↳ Reviewing & refining themes</div>
    <div class="lstep" id="ls5">↳ Extracting supporting excerpts</div>
  </div>
</div>

<!-- MODAL: PROJECT -->
<div class="modal-overlay" id="modal-project">
  <div class="modal">
    <div class="modal-title" id="modal-project-title">New Project</div>
    <div class="form-row"><label class="form-label">Project Title *</label><input type="text" id="proj-title-input" placeholder="e.g. Refugee Experience Study"></div>
    <div class="form-row"><label class="form-label">Description</label><textarea class="form-input" id="proj-desc-input" placeholder="Brief description..."></textarea></div>
    <div class="form-row"><label class="form-label">Research Question (optional)</label><input type="text" id="proj-rq-input" placeholder="What is your main research question?"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-project')">Cancel</button>
      <button class="btn-confirm" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- MODAL: ADD DOCUMENT -->
<div class="modal-overlay" id="modal-doc">
  <div class="modal">
    <div class="modal-title">Add Document</div>
    <div class="form-row"><label class="form-label">Title *</label><input type="text" id="doc-title-input" placeholder="e.g. Interview P01 - Maria Chen"></div>
    <div class="form-row"><label class="form-label">Source Type</label>
      <select id="doc-source-input">
        <option>Interview Transcript</option><option>Focus Group Transcript</option>
        <option>Field Notes</option><option>Open-ended Survey Responses</option>
        <option>Document / Archival Text</option><option>Diary / Journal Entry</option><option>Other</option>
      </select>
    </div>
    <div class="form-row"><label class="form-label">Text Content *</label><textarea class="form-input" id="doc-text-input" style="min-height:160px" placeholder="Paste your qualitative data here..."></textarea></div>
    <div style="margin-bottom:14px"><label class="form-label" style="display:block;margin-bottom:6px">Or upload .txt / .md file</label><input type="file" id="doc-file-input" accept=".txt,.md" onchange="readDocFile(event)" style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted)"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-doc')">Cancel</button>
      <button class="btn-confirm" onclick="saveDoc()">Add Document</button>
    </div>
  </div>
</div>

<!-- MODAL: API KEY -->
<div class="modal-overlay" id="modal-api">
  <div class="modal">
    <div class="modal-title">Update Gemini API Key</div>
    <div class="form-row"><label class="form-label">API Key</label><input type="password" id="api-key-input" placeholder="AIza..."></div>
    <div style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);line-height:1.8;margin-bottom:16px">Get a free key at <span style="color:var(--accent2)">aistudio.google.com</span> → Get API Key.</div>
    <div class="err-msg" id="api-err"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-api')">Cancel</button>
      <button class="btn-confirm" onclick="saveApiKey()">Save Key</button>
    </div>
  </div>
</div>

<!-- MODAL: VIEW DOCUMENT -->
<div class="modal-overlay" id="modal-view-doc">
  <div class="modal" style="width:640px;max-width:95vw">
    <div class="modal-title" id="view-doc-title"></div>
    <div style="font-family:var(--font-body);font-size:0.82rem;line-height:1.8;color:var(--text-muted);max-height:400px;overflow-y:auto;white-space:pre-wrap;border:1px solid var(--border);padding:14px;background:var(--bg)" id="view-doc-text"></div>
    <div class="modal-actions"><button class="btn-confirm" onclick="closeModal('modal-view-doc')">Close</button></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════
// SUPABASE INIT
// ═══════════════════════════════════════
const SUPABASE_URL = 'https://jzexnyzmvfuyzygfhtcr.supabase.co';
const SUPABASE_KEY = 'sb_publishable_XBA_1TaMR1RkPBw0mW8vOg_zshuICBw';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ═══════════════════════════════════════
// STATE
// ═══════════════════════════════════════
let currentUser = null;
let currentProjectId = null;
let editingProjectId = null;
let selectedMethod = 'reflexive_ta';
let categories = [];
let currentRunId = null;
let rsFilter = 'all';
let projects = [];
let documents = [];
let runs = [];
let notesTimer = null;

// ═══════════════════════════════════════
// AUTH
// ═══════════════════════════════════════
sb.auth.onAuthStateChange(async (event, session) => {
  if (session?.user) {
    currentUser = session.user;
    document.getElementById('auth-screen').style.display = 'none';
    // Check if user has API key
    const { data: profile } = await sb.from('profiles').select('gemini_key').eq('id', currentUser.id).single();
    if (!profile?.gemini_key) {
      showOnboarding();
    } else {
      showApp();
    }
  } else {
    currentUser = null;
    showAuth();
  }
});

async function signInWithGoogle() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: window.location.href }
  });
  if (error) alert('Sign in failed: ' + error.message);
}

async function signOut() {
  await sb.auth.signOut();
  showAuth();
}

function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('auth-screen').style.flex = '1';
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('topbar').style.display = 'none';
  document.getElementById('app').style.display = 'none';
}

function showOnboarding() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('onboarding-screen').style.display = 'flex';
  document.getElementById('onboarding-screen').style.flex = '1';
  document.getElementById('topbar').style.display = 'none';
  document.getElementById('app').style.display = 'none';
}

async function showApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('app').style.flex = '1';
  document.getElementById('user-email').textContent = currentUser.email;
  await loadProjects();
}

// ═══════════════════════════════════════
// ONBOARDING API KEY
// ═══════════════════════════════════════
async function saveOnboardKey() {
  const key = document.getElementById('onboard-key-input').value.trim();
  if (!key) return showErr('onboard-err', 'Please enter your API key.');
  if (!key.startsWith('AI')) return showErr('onboard-err', 'Key should start with "AI". Check aistudio.google.com.');
  showLoading('Saving your key...');
  const { error } = await sb.from('profiles').update({ gemini_key: key }).eq('id', currentUser.id);
  hideLoading();
  if (error) return showErr('onboard-err', 'Failed to save key: ' + error.message);
  showApp();
}

// ═══════════════════════════════════════
// API KEY MODAL
// ═══════════════════════════════════════
async function openApiModal() {
  const { data: profile } = await sb.from('profiles').select('gemini_key').eq('id', currentUser.id).single();
  document.getElementById('api-key-input').value = profile?.gemini_key || '';
  openModal('modal-api');
}

async function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key || !key.startsWith('AI')) return showErr('api-err', 'Invalid key. Should start with "AI".');
  const { error } = await sb.from('profiles').update({ gemini_key: key }).eq('id', currentUser.id);
  if (error) return showErr('api-err', 'Failed to save: ' + error.message);
  closeModal('modal-api');
}

async function getApiKey() {
  const { data: profile } = await sb.from('profiles').select('gemini_key').eq('id', currentUser.id).single();
  return profile?.gemini_key || '';
}

// ═══════════════════════════════════════
// PROJECTS
// ═══════════════════════════════════════
async function loadProjects() {
  showLoading('Loading projects...');
  const { data } = await sb.from('projects').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
  hideLoading();
  projects = data || [];
  renderSidebar();
}

function openNewProject() {
  editingProjectId = null;
  document.getElementById('modal-project-title').textContent = 'New Project';
  document.getElementById('proj-title-input').value = '';
  document.getElementById('proj-desc-input').value = '';
  document.getElementById('proj-rq-input').value = '';
  openModal('modal-project');
}

function editProject() {
  const p = projects.find(p => p.id === currentProjectId);
  if (!p) return;
  editingProjectId = p.id;
  document.getElementById('modal-project-title').textContent = 'Edit Project';
  document.getElementById('proj-title-input').value = p.title;
  document.getElementById('proj-desc-input').value = p.description || '';
  document.getElementById('proj-rq-input').value = p.research_question || '';
  openModal('modal-project');
}

async function saveProject() {
  const title = document.getElementById('proj-title-input').value.trim();
  if (!title) return alert('Title is required.');
  const data = {
    title,
    description: document.getElementById('proj-desc-input').value.trim(),
    research_question: document.getElementById('proj-rq-input').value.trim(),
    updated_at: new Date().toISOString()
  };
  showLoading('Saving project...');
  if (editingProjectId) {
    await sb.from('projects').update(data).eq('id', editingProjectId);
  } else {
    const { data: newProj } = await sb.from('projects').insert({ ...data, user_id: currentUser.id, status: 'active' }).select().single();
    if (newProj) { currentProjectId = newProj.id; }
  }
  await loadProjects();
  hideLoading();
  closeModal('modal-project');
  if (currentProjectId) openProjectView();
}

async function archiveProject() {
  const p = projects.find(p => p.id === currentProjectId);
  if (!p) return;
  const newStatus = p.status === 'archived' ? 'active' : 'archived';
  await sb.from('projects').update({ status: newStatus }).eq('id', currentProjectId);
  await loadProjects();
  renderProjectHeader();
}

async function deleteProject() {
  if (!confirm('Delete this project and all its data? This cannot be undone.')) return;
  showLoading('Deleting...');
  await sb.from('projects').delete().eq('id', currentProjectId);
  currentProjectId = null;
  await loadProjects();
  hideLoading();
  document.getElementById('project-view').style.display = 'none';
  document.getElementById('welcome').style.display = 'flex';
}

function renderSidebar() {
  const list = document.getElementById('projects-list');
  const empty = document.getElementById('empty-projects');
  if (!projects.length) { list.innerHTML = ''; list.appendChild(empty); empty.style.display = 'block'; return; }
  empty.style.display = 'none';
  list.innerHTML = '';
  projects.forEach(p => {
    const el = document.createElement('div');
    el.className = 'project-item' + (p.id === currentProjectId ? ' active' : '');
    el.onclick = async () => { currentProjectId = p.id; renderSidebar(); await openProjectView(); };    el.innerHTML = `<div class="proj-name">${escHtml(p.title)}</div><div class="proj-meta"><span class="proj-badge ${p.status}">${p.status}</span><span>${fmtDate(p.created_at)}</span></div>`;
    list.appendChild(el);
  });
}

async function openProjectView() {
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('project-view').style.display = 'flex';
  document.getElementById('project-view').style.flexDirection = 'column';
  renderProjectHeader();
  await switchTab('documents');
}

function renderProjectHeader() {
  const p = projects.find(p => p.id === currentProjectId);
  if (!p) return;
  document.getElementById('proj-title').textContent = p.title;
  document.getElementById('proj-desc').textContent = p.description || (p.research_question ? 'RQ: ' + p.research_question : '');
}

// ═══════════════════════════════════════
// TABS
// ═══════════════════════════════════════
async function switchTab(name) {
  document.querySelectorAll('.proj-tab').forEach((t, i) => {
    t.classList.toggle('active', ['documents','analysis','results','notes'][i] === name);
  });
  ['documents','analysis','results','notes'].forEach(t => {
    document.getElementById('tab-' + t).classList.toggle('active', t === name);
  });
  document.getElementById('export-bar').style.display = name === 'results' ? 'flex' : 'none';
  if (name === 'documents') await renderDocs();
  if (name === 'analysis') await renderRuns();
  if (name === 'results') await renderResults();
  if (name === 'notes') await loadNotes();
}

// ═══════════════════════════════════════
// DOCUMENTS
// ═══════════════════════════════════════
function openAddDoc() {
  document.getElementById('doc-title-input').value = '';
  document.getElementById('doc-text-input').value = '';
  document.getElementById('doc-source-input').selectedIndex = 0;
  openModal('modal-doc');
}

function readDocFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('doc-text-input').value = ev.target.result;
    if (!document.getElementById('doc-title-input').value)
      document.getElementById('doc-title-input').value = file.name.replace(/\.[^.]+$/, '');
  };
  reader.readAsText(file);
}

async function saveDoc() {
  const title = document.getElementById('doc-title-input').value.trim();
  const content = document.getElementById('doc-text-input').value.trim();
  if (!title || !content) return alert('Title and content are required.');
  showLoading('Saving document...');
  await sb.from('documents').insert({
    project_id: currentProjectId,
    title,
    source_type: document.getElementById('doc-source-input').value,
    content
  });
  hideLoading();
  closeModal('modal-doc');
  await renderDocs();
}

async function renderDocs() {
  const { data } = await sb.from('documents').select('*').eq('project_id', currentProjectId).order('created_at');
  documents = data || [];
  const tbody = document.getElementById('docs-tbody');
  const noDocs = document.getElementById('no-docs');
  const table = document.getElementById('docs-table');
  if (!documents.length) { tbody.innerHTML = ''; noDocs.style.display = 'block'; table.style.display = 'none'; return; }
  noDocs.style.display = 'none';
  table.style.display = 'table';
  tbody.innerHTML = documents.map(d => `
    <tr>
      <td>${escHtml(d.title)}</td>
      <td><span class="doc-source">${escHtml(d.source_type)}</span></td>
      <td class="doc-date">${fmtDate(d.created_at)}</td>
      <td><div class="doc-actions">
        <button class="small-btn" onclick="viewDoc('${d.id}')">View</button>
        <button class="small-btn danger" onclick="deleteDoc('${d.id}')">Delete</button>
      </div></td>
    </tr>`).join('');
}

function viewDoc(id) {
  const doc = documents.find(d => d.id === id);
  if (!doc) return;
  document.getElementById('view-doc-title').textContent = doc.title;
  document.getElementById('view-doc-text').textContent = doc.content;
  openModal('modal-view-doc');
}

async function deleteDoc(id) {
  if (!confirm('Delete this document?')) return;
  await sb.from('documents').delete().eq('id', id);
  await renderDocs();
}

// ═══════════════════════════════════════
// METHODOLOGY
// ═══════════════════════════════════════
function selectMethod(card) {
  document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  selectedMethod = card.dataset.method;
  document.getElementById('deductive-panel').style.display = selectedMethod === 'deductive_ta' ? 'block' : 'none';
}

function addCategory() {
  const input = document.getElementById('catInput');
  const val = input.value.trim();
  if (!val || categories.includes(val)) return;
  categories.push(val);
  input.value = '';
  renderCategories();
}

function removeCategory(cat) {
  categories = categories.filter(c => c !== cat);
  renderCategories();
}

function renderCategories() {
  document.getElementById('categories-list').innerHTML = categories.map(c =>
    `<span class="category-tag">${escHtml(c)}<button onclick="removeCategory('${escHtml(c)}')">&times;</button></span>`
  ).join('');
}

// ═══════════════════════════════════════
// ANALYSIS
// ═══════════════════════════════════════
const METHOD_INFO = {
  reflexive_ta: { name: 'Reflexive Thematic Analysis (Braun & Clarke, 2022)', instruction: 'Apply reflexive thematic analysis. The researcher plays an active role in theme construction. Be interpretive. Themes should be conceptual patterns of shared meaning, not mere topics.' },
  inductive_ta: { name: 'Inductive Thematic Analysis (bottom-up)', instruction: 'Let themes emerge entirely from the data without theoretical preconceptions. Codes and themes should be grounded purely in the data.' },
  deductive_ta: { name: 'Deductive Thematic Analysis (top-down)', instruction: 'Analyse the data using the predefined theoretical categories provided. Map data to these categories and identify how data confirms, extends, or challenges them.' },
  framework_ta: { name: 'Framework Analysis', instruction: 'Use a structured matrix-based approach. Identify a clear analytical framework and chart the data systematically, noting similarities and differences across cases.' },
  content_analysis: { name: 'Content Analysis (Bardin, 1977)', instruction: 'Apply systematic content analysis. Identify manifest and latent content. Focus on categorisation and patterns. Be systematic and exhaustive.' },
  narrative: { name: 'Narrative Analysis', instruction: 'Analyse narrative structure. How do participants construct their stories? Identify plot elements, turning points, and narrative identities.' }
};

function buildPrompt(text, method, lang, depth) {
  const m = METHOD_INFO[method] || METHOD_INFO.reflexive_ta;
  const depthNote = depth === 'brief' ? 'Keep analysis concise: 2-3 themes maximum.' : depth === 'detailed' ? 'Be thorough with rich, detailed analysis.' : 'Standard depth.';
  const catNote = method === 'deductive_ta' && categories.length ? `\nPredefined categories: ${categories.join(', ')}\n` : '';
  return `You are an expert qualitative researcher applying ${m.name}.\n${m.instruction}\n${depthNote}${catNote}\nRespond ONLY in valid JSON. All text must be in ${lang}.\n\nINPUT DATA:\n"""\n${text}\n"""\n\nReturn this exact JSON:\n{"summary":"...","total_codes":0,"total_themes":0,"themes":[{"theme_id":1,"theme_name":"...","theme_description":"...","subthemes":[{"subtheme_id":"1.1","subtheme_name":"...","subtheme_description":"...","codes":[{"code_id":"1.1.1","code_label":"...","code_description":"...","excerpts":[{"text":"verbatim quote","relevance":"why it supports the code"}]}]}]}],"analytical_memo":"..."}\n\nRules: verbatim excerpts only; each code needs at least one excerpt; themes must be conceptual.`;
}

async function runAnalysis() {
  const errEl = document.getElementById('analysis-err');
  errEl.classList.remove('visible');
  if (!documents.length) return showErr('analysis-err', 'No documents found. Add documents first.');
  const key = await getApiKey();
  if (!key) return showErr('analysis-err', 'No API key found. Click the API indicator in the top bar.');
  const combinedText = documents.map(d => `[${d.title}]\n${d.content}`).join('\n\n---\n\n');
  const lang = document.getElementById('opt-lang').value;
  const depth = document.getElementById('opt-depth').value;
  const prompt = buildPrompt(combinedText, selectedMethod, lang, depth);

  showLoading('Running analysis...');
  document.getElementById('run-btn').disabled = true;
  const steps = ['ls1','ls2','ls3','ls4','ls5'];
  let si = 0;
  const stepInt = setInterval(() => { if (si < steps.length) document.getElementById(steps[si++]).classList.add('active'); }, 1400);

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0.3, maxOutputTokens: 8192 } })
    });
    clearInterval(stepInt);
    steps.forEach(s => document.getElementById(s).classList.remove('active'));
    hideLoading();
    document.getElementById('run-btn').disabled = false;

    if (!res.ok) {
      const err = await res.json();
      let msg = err.error?.message || `HTTP ${res.status}`;
      if (res.status === 400 || msg.includes('API_KEY')) msg = 'Invalid API key. Update it via the API indicator in the top bar.';
      if (res.status === 429) msg = 'Rate limit reached. Wait a moment and try again.';
      return showErr('analysis-err', msg);
    }

    const data = await res.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!raw) return showErr('analysis-err', 'Empty response from API. Try again.');
    const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    const analysis = JSON.parse(clean);
    const m = METHOD_INFO[selectedMethod];

    showLoading('Saving results...');
    const { data: run } = await sb.from('analysis_runs').insert({
      project_id: currentProjectId,
      method: m.name,
      method_key: selectedMethod,
      language: lang,
      depth,
      categories: categories,
      docs_count: documents.length,
      status: 'complete',
      result: analysis
    }).select().single();

    hideLoading();
    if (run) currentRunId = run.id;
    await renderRuns();
    await switchTab('results');

  } catch(err) {
    clearInterval(stepInt);
    steps.forEach(s => document.getElementById(s).classList.remove('active'));
    hideLoading();
    document.getElementById('run-btn').disabled = false;
    showErr('analysis-err', err.message.includes('JSON') ? 'Failed to parse AI response. Try again.' : err.message);
  }
}

// ═══════════════════════════════════════
// RUNS
// ═══════════════════════════════════════
async function renderRuns() {
  const { data } = await sb.from('analysis_runs').select('id,method,language,depth,docs_count,status,created_at').eq('project_id', currentProjectId).order('created_at', { ascending: false });
  runs = data || [];
  const list = document.getElementById('runs-list');
  const noRuns = document.getElementById('no-runs');
  if (!runs.length) { list.innerHTML = ''; noRuns.style.display = 'block'; return; }
  noRuns.style.display = 'none';
  list.innerHTML = runs.map((r, i) => `
    <div class="run-item ${r.id === currentRunId ? 'selected-run' : ''}" onclick="selectRun('${r.id}')">
      <div class="run-number">Run #${runs.length - i}</div>
      <div class="run-info">
        <div class="run-method">${escHtml(r.method)}</div>
        <div class="run-meta">${fmtDate(r.created_at)} · ${r.docs_count} doc(s) · ${r.language}</div>
      </div>
      <span class="run-status complete">complete</span>
      <div class="run-actions">
        <button class="small-btn" onclick="event.stopPropagation();selectRun('${r.id}');switchTab('results')">View</button>
        <button class="small-btn danger" onclick="event.stopPropagation();deleteRun('${r.id}')">Del</button>
      </div>
    </div>`).join('');
}

async function selectRun(id) {
  currentRunId = id;
  await renderRuns();
  await switchTab('results');
}

async function deleteRun(id) {
  if (!confirm('Delete this run?')) return;
  await sb.from('analysis_runs').delete().eq('id', id);
  if (currentRunId === id) currentRunId = null;
  await renderRuns();
  await renderResults();
}

// ═══════════════════════════════════════
// RESULTS
// ═══════════════════════════════════════
async function renderResults() {
  const noResults = document.getElementById('no-results');
  const content = document.getElementById('results-content');
  let run = null;
  if (currentRunId) {
    const { data } = await sb.from('analysis_runs').select('*').eq('id', currentRunId).single();
    run = data;
  } else if (runs.length) {
    const { data } = await sb.from('analysis_runs').select('*').eq('project_id', currentProjectId).order('created_at', { ascending: false }).limit(1).single();
    run = data;
    if (run) currentRunId = run.id;
  }
  if (!run) { noResults.style.display = 'block'; content.style.display = 'none'; renderRsSidebar(null); return; }
  noResults.style.display = 'none';
  content.style.display = 'block';
  const a = run.result;
  let html = `
    <div class="results-stats fade-up">
      <div class="stat-item"><div class="stat-val">${a.total_themes || a.themes?.length || '—'}</div><div class="stat-lbl">Themes</div></div>
      <div class="stat-item"><div class="stat-val">${a.total_codes || '—'}</div><div class="stat-lbl">Codes</div></div>
      <div class="stat-item"><div class="stat-val">${run.docs_count}</div><div class="stat-lbl">Documents</div></div>
    </div>
    <div class="result-summary fade-up">${escHtml(a.summary)}</div>`;

  (a.themes || []).forEach((theme, ti) => {
    const subHtml = (theme.subthemes || []).map(sub => {
      const codesHtml = (sub.codes || []).map(code => {
        const exHtml = (code.excerpts || []).map(ex => `
          <div class="excerpt-item">
            <div class="excerpt-quote">"${escHtml(ex.text)}"</div>
            <div class="excerpt-rel">${escHtml(ex.relevance)}</div>
          </div>`).join('');
        return `<div class="code-block" onclick="toggleCode(this)">
          <div class="code-top"><span class="code-id-lbl">${escHtml(code.code_id)}</span><span class="code-label">${escHtml(code.code_label)}</span></div>
          <div class="code-desc">${escHtml(code.code_description)}</div>
          <div class="excerpts-toggle">▸ ${code.excerpts?.length||0} excerpt(s)</div>
          <div class="excerpts-wrap">${exHtml}</div>
        </div>`;
      }).join('');
      return `<div class="subtheme">
        <div class="sub-name"><span class="sub-id">${escHtml(sub.subtheme_id)}</span>${escHtml(sub.subtheme_name)}</div>
        <div class="sub-desc">${escHtml(sub.subtheme_description)}</div>
        ${codesHtml}
      </div>`;
    }).join('');
    html += `<div class="theme-card fade-up" id="theme-${ti}">
      <div class="theme-hdr" onclick="toggleTheme(this)">
        <div class="theme-num">0${ti+1}</div>
        <div class="theme-info"><div class="theme-name">${escHtml(theme.theme_name)}</div><div class="theme-desc">${escHtml(theme.theme_description)}</div></div>
        <div class="theme-chevron">▾</div>
      </div>
      <div class="theme-body">${subHtml}</div>
    </div>`;
  });

  if (a.analytical_memo) html += `<div class="memo-card fade-up"><div class="memo-lbl">Analytical Memo</div><div class="memo-text">${escHtml(a.analytical_memo)}</div></div>`;
  content.innerHTML = html;
  renderRsSidebar(a);
}

function toggleTheme(hdr) {
  hdr.nextElementSibling.classList.toggle('open');
  hdr.querySelector('.theme-chevron').classList.toggle('open');
}

function toggleCode(block) {
  const wrap = block.querySelector('.excerpts-wrap');
  wrap.classList.toggle('open');
  block.classList.toggle('open');
  const count = block.querySelectorAll('.excerpt-item').length;
  block.querySelector('.excerpts-toggle').textContent = wrap.classList.contains('open') ? `▾ ${count} excerpt(s)` : `▸ ${count} excerpt(s)`;
}

function renderRsSidebar(analysis) {
  const list = document.getElementById('rs-list');
  if (!analysis) { list.innerHTML = ''; return; }
  list.innerHTML = '';
  const search = document.getElementById('rs-search').value.toLowerCase();
  (analysis.themes || []).forEach((theme, ti) => {
    if (rsFilter !== 'codes') {
      if (!search || theme.theme_name.toLowerCase().includes(search)) {
        const div = document.createElement('div');
        div.className = 'rs-item';
        div.innerHTML = `<div class="rs-item-theme">Theme ${ti+1}</div><div class="rs-item-name">${escHtml(theme.theme_name)}</div>`;
        div.onclick = () => scrollToTheme(ti);
        list.appendChild(div);
      }
    }
    if (rsFilter !== 'themes') {
      (theme.subthemes || []).forEach(sub => (sub.codes || []).forEach(code => {
        const ex = code.excerpts?.[0];
        if (search && !code.code_label.toLowerCase().includes(search) && !ex?.text.toLowerCase().includes(search)) return;
        const div = document.createElement('div');
        div.className = 'rs-item';
        div.innerHTML = `<div class="rs-item-theme">${escHtml(theme.theme_name)}</div><div class="rs-item-name" style="color:var(--accent3)">${escHtml(code.code_label)}</div>${ex?`<div class="rs-item-excerpt">"${escHtml(ex.text)}"</div>`:''}`;
        list.appendChild(div);
      }));
    }
  });
}

function setRsFilter(btn) {
  document.querySelectorAll('.rs-filter').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  rsFilter = btn.dataset.filter;
  const el = document.getElementById('results-content');
  if (el.style.display !== 'none') {
    // re-render sidebar from current run
    sb.from('analysis_runs').select('result').eq('id', currentRunId).single().then(({ data }) => { if (data) renderRsSidebar(data.result); });
  }
}

function filterResults() {
  sb.from('analysis_runs').select('result').eq('id', currentRunId).single().then(({ data }) => { if (data) renderRsSidebar(data.result); });
}

function scrollToTheme(idx) {
  const el = document.getElementById('theme-' + idx);
  if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); el.classList.add('highlighted'); setTimeout(() => el.classList.remove('highlighted'), 2000); }
}

// ═══════════════════════════════════════
// NOTES
// ═══════════════════════════════════════
async function loadNotes() {
  const p = projects.find(p => p.id === currentProjectId);
  document.getElementById('notes-area').value = p?.notes || '';
  document.getElementById('notes-saved').textContent = '';
}

async function saveNotes() {
  const notes = document.getElementById('notes-area').value;
  await sb.from('projects').update({ notes }).eq('id', currentProjectId);
  const p = projects.find(p => p.id === currentProjectId);
  if (p) p.notes = notes;
  document.getElementById('notes-saved').textContent = 'Saved · ' + new Date().toLocaleTimeString();
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('notes-area')?.addEventListener('input', () => {
    clearTimeout(notesTimer);
    notesTimer = setTimeout(saveNotes, 2000);
  });
});

// ═══════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════
async function getCurrentAnalysis() {
  if (!currentRunId) return null;
  const { data } = await sb.from('analysis_runs').select('result').eq('id', currentRunId).single();
  return data?.result || null;
}

async function exportTXT() {
  const a = await getCurrentAnalysis();
  const p = projects.find(p => p.id === currentProjectId);
  if (!a) return alert('No analysis to export.');
  let txt = `THEMELENS — QUALITATIVE ANALYSIS REPORT\n${'═'.repeat(50)}\nProject: ${p.title}\nDate: ${new Date().toLocaleDateString()}\n\nSUMMARY\n${a.summary}\n\nThemes: ${a.total_themes} | Codes: ${a.total_codes}\n\n${'═'.repeat(50)}\n\n`;
  (a.themes||[]).forEach((t,i) => {
    txt += `THEME ${i+1}: ${t.theme_name}\n${t.theme_description}\n\n`;
    (t.subthemes||[]).forEach(s => {
      txt += `  ${s.subtheme_id} ${s.subtheme_name}\n  ${s.subtheme_description}\n\n`;
      (s.codes||[]).forEach(c => {
        txt += `    [${c.code_id}] ${c.code_label}\n    ${c.code_description}\n`;
        (c.excerpts||[]).forEach(e => txt += `      → "${e.text}"\n        (${e.relevance})\n`);
        txt += '\n';
      });
    });
    txt += '─'.repeat(50) + '\n\n';
  });
  if (a.analytical_memo) txt += `ANALYTICAL MEMO\n${a.analytical_memo}\n`;
  download(new Blob([txt],{type:'text/plain;charset=utf-8'}), 'themelens_report.txt');
}

async function exportCSV() {
  const a = await getCurrentAnalysis();
  if (!a) return alert('No analysis to export.');
  let rows = [['Theme','Subtheme','Code ID','Code','Code Description','Excerpt','Relevance']];
  (a.themes||[]).forEach(t => (t.subthemes||[]).forEach(s => (s.codes||[]).forEach(c => (c.excerpts||[]).forEach(e => {
    rows.push([t.theme_name, s.subtheme_name, c.code_id, c.code_label, c.code_description, e.text, e.relevance]);
  }))));
  const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download(new Blob([csv],{type:'text/csv;charset=utf-8'}), 'themelens_codes.csv');
}

async function exportJSON() {
  const a = await getCurrentAnalysis();
  const p = projects.find(p => p.id === currentProjectId);
  if (!a) return alert('No analysis to export.');
  download(new Blob([JSON.stringify({project:p.title,exported:new Date().toISOString(),analysis:a},null,2)],{type:'application/json'}), 'themelens_analysis.json');
}

function download(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════
function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg || 'Loading...';
  document.getElementById('loading-overlay').classList.add('visible');
  ['ls1','ls2','ls3','ls4','ls5'].forEach(s => document.getElementById(s).classList.remove('active'));
}
function hideLoading() { document.getElementById('loading-overlay').classList.remove('visible'); }
function openModal(id) { document.getElementById(id).classList.add('visible'); }
function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
function showErr(id, msg) { const el = document.getElementById(id); el.textContent = '✗ ' + msg; el.classList.add('visible'); }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtDate(iso) { try { return new Date(iso).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); } catch(e) { return ''; } }
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('visible'); }));
</script>
</body>
</html>
