<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ThemeLens — Qualitative Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #111213;
  --sidebar-bg: #0d0e0f;
  --surface: #18191b;
  --surface2: #1f2022;
  --surface3: #252729;
  --border: #2c2e30;
  --border2: #363a3c;
  --accent: #e8c547;
  --accent2: #47b8e8;
  --accent3: #e84778;
  --accent4: #47e8a0;
  --text: #dde0e2;
  --text-muted: #7a8285;
  --text-dim: #404548;
  --font-display: 'Lora', serif;
  --font-mono: 'IBM Plex Mono', monospace;
  --font-body: 'IBM Plex Sans', sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);font-weight:300;font-size:14px;display:flex;flex-direction:column}

/* ── TOPBAR ── */
#topbar{height:48px;background:var(--sidebar-bg);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:16px;flex-shrink:0;z-index:100}
.logo-mark{font-family:var(--font-display);font-size:1.1rem;font-weight:600;color:var(--text);letter-spacing:-0.01em}
.logo-mark span{color:var(--accent)}
.topbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.topbar-btn{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);background:none;border:1px solid var(--border);padding:5px 12px;cursor:pointer;transition:all 0.15s}
.topbar-btn:hover{border-color:var(--accent);color:var(--accent)}
.topbar-btn.primary{background:var(--accent);color:#111;border-color:var(--accent);font-weight:500}
.topbar-btn.primary:hover{background:#f0d060;color:#111}
#apiStatus{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);margin-left:auto;display:flex;align-items:center;gap:6px;cursor:pointer}
#apiDot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
#apiDot.ok{background:var(--accent4)}
#apiDot.err{background:var(--accent3)}

/* ── LAYOUT ── */
#app{display:flex;flex:1;overflow:hidden}

/* ── LEFT SIDEBAR ── */
#sidebar{width:240px;background:var(--sidebar-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-title{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted)}
.icon-btn{width:24px;height:24px;background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;flex-shrink:0}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
#projects-list{flex:1;overflow-y:auto;padding:8px}
.project-item{padding:10px 12px;cursor:pointer;border:1px solid transparent;margin-bottom:2px;transition:all 0.15s;border-radius:2px}
.project-item:hover{background:var(--surface);border-color:var(--border)}
.project-item.active{background:var(--surface);border-color:var(--accent)}
.proj-name{font-size:0.82rem;font-weight:400;color:var(--text);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.proj-meta{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);display:flex;gap:8px}
.proj-badge{padding:1px 5px;border-radius:2px;font-size:0.58rem}
.proj-badge.active{background:rgba(72,184,232,0.15);color:var(--accent2)}
.proj-badge.archived{background:rgba(100,100,100,0.15);color:var(--text-dim)}
.empty-state{padding:24px 12px;text-align:center;font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);line-height:1.8}

/* ── MAIN AREA ── */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* WELCOME SCREEN */
#welcome{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:24px;padding:48px}
.welcome-title{font-family:var(--font-display);font-size:2rem;font-weight:600;color:var(--text);text-align:center}
.welcome-sub{font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);letter-spacing:0.1em;text-align:center;line-height:1.8}
.welcome-actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px}

/* PROJECT VIEW */
#project-view{flex:1;display:none;flex-direction:column;overflow:hidden}
#project-topbar{padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-shrink:0}
.project-title-area{flex:1}
#proj-title{font-family:var(--font-display);font-size:1.4rem;font-weight:600;color:var(--text);margin-bottom:4px}
#proj-desc{font-size:0.8rem;color:var(--text-muted);font-weight:300}
.project-actions{display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}

/* TABS */
#proj-tabs{padding:0 24px;border-bottom:1px solid var(--border);display:flex;gap:0;flex-shrink:0}
.proj-tab{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;padding:12px 16px;cursor:pointer;color:var(--text-muted);border-bottom:2px solid transparent;transition:all 0.15s;background:none;border-top:none;border-left:none;border-right:none}
.proj-tab:hover{color:var(--text)}
.proj-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* TAB CONTENT */
#tab-content{flex:1;overflow:hidden;display:flex}

/* DOCUMENTS TAB */
#tab-documents{flex:1;overflow-y:auto;padding:24px;display:none}
#tab-documents.active{display:block}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-label{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted)}
.docs-table{width:100%;border-collapse:collapse}
.docs-table th{font-family:var(--font-mono);font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);padding:8px 12px;text-align:left;border-bottom:1px solid var(--border)}
.docs-table td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:0.82rem;vertical-align:middle}
.docs-table tr:hover td{background:var(--surface)}
.doc-name{font-weight:400;color:var(--text)}
.doc-source{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-muted);padding:2px 6px;background:var(--surface2);border:1px solid var(--border)}
.doc-date{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim)}
.doc-actions{display:flex;gap:6px}
.small-btn{font-family:var(--font-mono);font-size:0.6rem;padding:4px 8px;background:none;border:1px solid var(--border);color:var(--text-muted);cursor:pointer;transition:all 0.12s}
.small-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.small-btn.danger:hover{border-color:var(--accent3);color:var(--accent3)}

/* ANALYSIS TAB */
#tab-analysis{flex:1;overflow-y:auto;padding:24px;display:none}
#tab-analysis.active{display:block}

/* METHODOLOGY CARDS */
.method-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.method-card{border:1px solid var(--border);padding:14px 16px;cursor:pointer;transition:all 0.15s;background:var(--surface)}
.method-card:hover{border-color:var(--accent);background:var(--surface2)}
.method-card.selected{border-color:var(--accent);background:rgba(232,197,71,0.06)}
.method-card.selected .method-name{color:var(--accent)}
.method-tag{font-family:var(--font-mono);font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}
.method-name{font-size:0.85rem;font-weight:500;color:var(--text);margin-bottom:4px}
.method-desc{font-size:0.72rem;color:var(--text-muted);line-height:1.55}
.method-card.selected .method-check{display:block}
.method-check{display:none;font-family:var(--font-mono);font-size:0.6rem;color:var(--accent);margin-top:8px}

/* ANALYSIS OPTIONS */
.options-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.opt-group{display:flex;flex-direction:column;gap:6px}
.opt-label{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted)}
select,input[type=text],input[type=password],textarea{background:var(--surface);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:0.78rem;padding:8px 12px;outline:none;width:100%;transition:border-color 0.15s}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%237a8285'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer}
select:focus,input:focus,textarea:focus{border-color:var(--accent)}

/* DEDUCTIVE CATEGORIES */
#deductive-panel{display:none;margin-bottom:24px;border:1px solid var(--border);padding:16px;background:var(--surface)}
.deductive-header{font-family:var(--font-mono);font-size:0.62rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent2);margin-bottom:10px}
#categories-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;min-height:28px}
.category-tag{background:rgba(71,184,232,0.1);border:1px solid rgba(71,184,232,0.3);color:var(--accent2);font-family:var(--font-mono);font-size:0.65rem;padding:3px 8px;display:flex;align-items:center;gap:6px}
.category-tag button{background:none;border:none;color:var(--accent2);cursor:pointer;font-size:0.7rem;opacity:0.6;padding:0}
.category-tag button:hover{opacity:1}
.add-cat-row{display:flex;gap:8px}
#catInput{flex:1}

/* ANALYSIS RUN BTN */
.run-bar{display:flex;align-items:center;gap:16px;padding:16px 0;border-top:1px solid var(--border);margin-top:8px}
.btn-run{font-family:var(--font-display);font-size:0.95rem;font-weight:600;background:var(--accent);color:#111;border:none;padding:12px 36px;cursor:pointer;transition:all 0.2s;letter-spacing:0.01em}
.btn-run:hover:not(:disabled){background:#f0d060;transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,197,71,0.25)}
.btn-run:disabled{opacity:0.35;cursor:not-allowed}
.run-note{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);line-height:1.7}

/* RUNS LIST */
.runs-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--border)}
.run-item{border:1px solid var(--border);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:16px;background:var(--surface);transition:border-color 0.15s;cursor:pointer}
.run-item:hover{border-color:var(--accent2)}
.run-item.selected-run{border-color:var(--accent)}
.run-number{font-family:var(--font-mono);font-size:0.65rem;color:var(--text-dim);width:56px;flex-shrink:0}
.run-info{flex:1}
.run-method{font-size:0.82rem;font-weight:400;color:var(--text);margin-bottom:2px}
.run-meta{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim)}
.run-status{font-family:var(--font-mono);font-size:0.58rem;padding:3px 8px;border-radius:2px}
.run-status.complete{background:rgba(71,232,160,0.1);color:var(--accent4)}
.run-status.running{background:rgba(232,197,71,0.1);color:var(--accent)}
.run-status.failed{background:rgba(232,71,120,0.1);color:var(--accent3)}
.run-actions{display:flex;gap:6px}

/* RESULTS TAB */
#tab-results{flex:1;overflow:hidden;display:none;flex-direction:row}
#tab-results.active{display:flex}

/* RESULTS MAIN */
#results-main{flex:1;overflow-y:auto;padding:24px}
.result-summary{background:var(--surface);border-left:3px solid var(--accent2);padding:14px 18px;margin-bottom:24px;font-size:0.85rem;line-height:1.7;color:var(--text-muted)}
.results-stats{display:flex;gap:24px;margin-bottom:24px}
.stat-item{text-align:center}
.stat-val{font-family:var(--font-display);font-size:1.8rem;font-weight:600;color:var(--accent);line-height:1}
.stat-lbl{font-family:var(--font-mono);font-size:0.58rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-dim);margin-top:4px}

/* THEME CARDS */
.theme-card{border:1px solid var(--border);margin-bottom:16px;background:var(--surface);overflow:hidden;transition:border-color 0.15s}
.theme-card:hover{border-color:var(--border2)}
.theme-card.highlighted{border-color:var(--accent)}
.theme-hdr{padding:16px 20px;cursor:pointer;display:flex;align-items:flex-start;gap:14px;user-select:none}
.theme-hdr:hover{background:rgba(232,197,71,0.03)}
.theme-num{font-family:var(--font-display);font-size:2.2rem;font-weight:600;color:var(--text-dim);line-height:1;flex-shrink:0;width:44px}
.theme-info{flex:1}
.theme-name{font-family:var(--font-display);font-size:1.05rem;font-weight:600;color:var(--text);margin-bottom:4px}
.theme-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.6}
.theme-chevron{font-size:0.7rem;color:var(--text-dim);flex-shrink:0;padding-top:4px;transition:transform 0.2s}
.theme-chevron.open{transform:rotate(180deg)}
.theme-body{display:none;border-top:1px solid var(--border);padding:0 20px 20px}
.theme-body.open{display:block}

/* SUBTHEMES */
.subtheme{margin-top:16px;padding-left:16px;border-left:2px solid var(--accent2)}
.sub-name{font-family:var(--font-mono);font-size:0.72rem;font-weight:500;color:var(--accent2);margin-bottom:4px}
.sub-id{font-size:0.58rem;color:var(--text-dim);margin-right:6px}
.sub-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.6;margin-bottom:10px}

/* CODES */
.code-block{background:var(--surface2);border:1px solid var(--border);padding:10px 14px;margin-bottom:8px;cursor:pointer;transition:border-color 0.15s}
.code-block:hover{border-color:var(--accent3)}
.code-block.open{border-color:var(--accent3)}
.code-top{display:flex;align-items:flex-start;gap:8px;margin-bottom:4px}
.code-id-lbl{font-family:var(--font-mono);font-size:0.58rem;color:var(--text-dim);flex-shrink:0;padding-top:1px}
.code-label{font-family:var(--font-mono);font-size:0.72rem;font-weight:500;color:var(--accent3)}
.code-desc{font-size:0.75rem;color:var(--text-muted);line-height:1.55;padding-left:36px;margin-bottom:6px}
.excerpts-wrap{display:none;padding-left:36px}
.excerpts-wrap.open{display:block}
.excerpt-item{border-left:2px solid rgba(232,71,120,0.4);padding:8px 12px;margin:6px 0;background:rgba(232,71,120,0.04)}
.excerpt-quote{font-family:var(--font-display);font-size:0.85rem;font-style:italic;color:var(--text);line-height:1.65;margin-bottom:4px}
.excerpt-rel{font-size:0.7rem;color:var(--text-dim);line-height:1.5}
.excerpts-toggle{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);letter-spacing:0.08em;padding-left:36px;margin-top:2px}
.excerpts-toggle:hover{color:var(--accent3)}

/* MEMO */
.memo-card{border:1px solid var(--border);border-left:3px solid var(--accent);padding:16px 20px;margin-top:24px;background:var(--surface)}
.memo-lbl{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.memo-text{font-size:0.82rem;color:var(--text-muted);line-height:1.7}

/* RESULTS SIDEBAR */
#results-sidebar{width:260px;border-left:1px solid var(--border);background:var(--sidebar-bg);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.rs-header{padding:14px 16px;border-bottom:1px solid var(--border)}
.rs-title{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px}
#rs-search{font-size:0.75rem;padding:7px 10px}
.rs-filters{padding:10px 16px;border-bottom:1px solid var(--border);display:flex;gap:6px}
.rs-filter{font-family:var(--font-mono);font-size:0.6rem;padding:4px 8px;border:1px solid var(--border);background:none;color:var(--text-muted);cursor:pointer;transition:all 0.12s}
.rs-filter.active{background:var(--accent);color:#111;border-color:var(--accent)}
#rs-list{flex:1;overflow-y:auto;padding:8px}
.rs-item{padding:10px 12px;border:1px solid transparent;margin-bottom:2px;cursor:pointer;transition:all 0.12s}
.rs-item:hover{background:var(--surface);border-color:var(--border)}
.rs-item.active{background:var(--surface);border-color:var(--accent)}
.rs-item-theme{font-family:var(--font-mono);font-size:0.6rem;color:var(--text-dim);margin-bottom:3px}
.rs-item-name{font-size:0.78rem;color:var(--text);margin-bottom:4px}
.rs-item-excerpt{font-size:0.7rem;color:var(--text-muted);line-height:1.5;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rs-item-source{font-family:var(--font-mono);font-size:0.58rem;color:var(--text-dim);margin-top:4px}

/* NOTES TAB */
#tab-notes{flex:1;overflow-y:auto;padding:24px;display:none;flex-direction:column;gap:16px}
#tab-notes.active{display:flex}
#notes-area{flex:1;min-height:300px;resize:none;font-family:var(--font-body);font-size:0.85rem;font-weight:300;line-height:1.8;padding:16px}
.notes-footer{display:flex;justify-content:space-between;align-items:center}
.notes-saved{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim)}

/* EXPORT BAR */
.export-bar{padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap;background:var(--sidebar-bg)}

/* LOADING */
#loading-overlay{display:none;position:fixed;inset:0;background:rgba(13,14,15,0.9);z-index:1000;align-items:center;justify-content:center;flex-direction:column;gap:20px}
#loading-overlay.visible{display:flex}
.spinner{width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-msg{font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);letter-spacing:0.1em;text-align:center}
.loading-steps{display:flex;flex-direction:column;gap:5px;align-items:center}
.lstep{font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);transition:color 0.3s}
.lstep.active{color:var(--accent)}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center}
.modal-overlay.visible{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);padding:28px;width:480px;max-width:90vw;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--font-display);font-size:1.2rem;font-weight:600;margin-bottom:20px;color:var(--text)}
.form-row{margin-bottom:14px}
.form-label{font-family:var(--font-mono);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;display:block}
textarea.form-input{min-height:80px;resize:vertical;font-family:var(--font-body);font-size:0.82rem}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.btn-cancel{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.08em;background:none;border:1px solid var(--border);color:var(--text-muted);padding:8px 16px;cursor:pointer}
.btn-cancel:hover{border-color:var(--accent3);color:var(--accent3)}
.btn-confirm{font-family:var(--font-mono);font-size:0.65rem;letter-spacing:0.08em;background:var(--accent);color:#111;border:none;padding:8px 20px;cursor:pointer;font-weight:500}
.btn-confirm:hover{background:#f0d060}

/* ERROR */
.err-msg{background:rgba(232,71,120,0.08);border:1px solid rgba(232,71,120,0.25);border-left:3px solid var(--accent3);padding:10px 14px;font-family:var(--font-mono);font-size:0.72rem;color:var(--accent3);margin-top:12px;display:none;line-height:1.6}
.err-msg.visible{display:block}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border)}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp 0.3s ease forwards}
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo-mark">Theme<span>Lens</span></div>
  <div class="topbar-sep"></div>
  <button class="topbar-btn primary" onclick="openNewProject()">+ New Project</button>
  <button class="topbar-btn" onclick="openApiModal()">API Key</button>
  <div id="apiStatus" onclick="openApiModal()">
    <div id="apiDot"></div>
    <span id="apiStatusText">No API key</span>
  </div>
</div>

<!-- APP -->
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebar-header">
      <span class="sidebar-title">Projects</span>
      <button class="icon-btn" onclick="openNewProject()" title="New project">+</button>
    </div>
    <div id="projects-list">
      <div class="empty-state" id="empty-projects">No projects yet.<br>Create one to begin.</div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">

    <!-- WELCOME -->
    <div id="welcome">
      <div class="welcome-title">Qualitative Analysis,<br>simplified.</div>
      <div class="welcome-sub">Thematic Analysis · Content Analysis · Narrative Analysis<br>Powered by Gemini AI · Your data stays local</div>
      <div class="welcome-actions">
        <button class="topbar-btn primary" onclick="openNewProject()">+ Create your first project</button>
        <button class="topbar-btn" onclick="openApiModal()">Configure API Key</button>
      </div>
    </div>

    <!-- PROJECT VIEW -->
    <div id="project-view">
      <div id="project-topbar">
        <div class="project-title-area">
          <div id="proj-title"></div>
          <div id="proj-desc"></div>
        </div>
        <div class="project-actions">
          <button class="topbar-btn" onclick="editProject()">Edit</button>
          <button class="topbar-btn" onclick="archiveProject()">Archive</button>
          <button class="topbar-btn" style="color:var(--accent3);border-color:var(--accent3)" onclick="deleteProject()">Delete</button>
        </div>
      </div>

      <div id="proj-tabs">
        <button class="proj-tab active" onclick="switchTab('documents')">Documents</button>
        <button class="proj-tab" onclick="switchTab('analysis')">Analysis</button>
        <button class="proj-tab" onclick="switchTab('results')">Results</button>
        <button class="proj-tab" onclick="switchTab('notes')">Researcher Notes</button>
      </div>

      <div id="tab-content">

        <!-- DOCUMENTS -->
        <div id="tab-documents" class="active">
          <div class="section-header">
            <span class="section-label">Documents</span>
            <button class="topbar-btn primary" onclick="openAddDoc()">+ Add Document</button>
          </div>
          <table class="docs-table" id="docs-table">
            <thead><tr>
              <th>Title</th><th>Source Type</th><th>Added</th><th>Actions</th>
            </tr></thead>
            <tbody id="docs-tbody"></tbody>
          </table>
          <div id="no-docs" class="empty-state" style="text-align:left;padding:24px 0">No documents yet. Add your first document to begin.</div>
        </div>

        <!-- ANALYSIS -->
        <div id="tab-analysis">
          <div class="section-label" style="margin-bottom:16px">Select Methodology</div>

          <div class="method-grid" id="method-grid">
            <div class="method-card" data-method="reflexive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Reflexive TA</div>
              <div class="method-desc">Braun & Clarke (2022). Researcher-driven, iterative construction of themes.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="inductive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Inductive TA</div>
              <div class="method-desc">Bottom-up. Themes emerge entirely from data without theoretical preconceptions.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="deductive_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Deductive TA</div>
              <div class="method-desc">Top-down. Analysis guided by predefined theoretical categories.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="framework_ta" onclick="selectMethod(this)">
              <div class="method-tag">Thematic Analysis</div>
              <div class="method-name">Framework Analysis</div>
              <div class="method-desc">Structured, matrix-based approach. Common in applied/policy research.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="content_analysis" onclick="selectMethod(this)">
              <div class="method-tag">Content Analysis</div>
              <div class="method-name">Content Analysis</div>
              <div class="method-desc">Bardin (1977). Systematic categorisation and quantification of content.</div>
              <div class="method-check">✓ Selected</div>
            </div>
            <div class="method-card" data-method="narrative" onclick="selectMethod(this)">
              <div class="method-tag">Narrative Analysis</div>
              <div class="method-name">Narrative Analysis</div>
              <div class="method-desc">Preserves story structure. Analyses how participants construct their narratives.</div>
              <div class="method-check">✓ Selected</div>
            </div>
          </div>

          <!-- DEDUCTIVE CATEGORIES -->
          <div id="deductive-panel">
            <div class="deductive-header">Predefined Categories / Theoretical Framework</div>
            <div id="categories-list"></div>
            <div class="add-cat-row">
              <input type="text" id="catInput" placeholder="Add a category (press Enter)..." onkeydown="if(event.key==='Enter')addCategory()">
              <button class="topbar-btn" onclick="addCategory()">Add</button>
            </div>
          </div>

          <!-- OPTIONS -->
          <div class="section-label" style="margin-bottom:12px">Analysis Options</div>
          <div class="options-grid">
            <div class="opt-group">
              <label class="opt-label">Language of Output</label>
              <select id="opt-lang">
                <option value="English">English</option>
                <option value="European Portuguese">Português</option>
                <option value="Spanish">Español</option>
              </select>
            </div>
            <div class="opt-group">
              <label class="opt-label">Depth</label>
              <select id="opt-depth">
                <option value="standard">Standard</option>
                <option value="detailed">Detailed</option>
                <option value="brief">Brief / Overview</option>
              </select>
            </div>
            <div class="opt-group">
              <label class="opt-label">Documents to Analyse</label>
              <select id="opt-docs">
                <option value="all">All documents</option>
                <option value="selected">Selected only</option>
              </select>
            </div>
          </div>

          <div class="err-msg" id="analysis-err"></div>

          <div class="run-bar">
            <button class="btn-run" id="run-btn" onclick="runAnalysis()">Run Analysis</button>
            <div class="run-note">Analysis runs against Gemini API.<br>Results are saved locally to this project.</div>
          </div>

          <!-- RUNS HISTORY -->
          <div class="runs-section">
            <div class="section-label" style="margin-bottom:12px">Analysis Runs</div>
            <div id="runs-list"></div>
            <div id="no-runs" class="empty-state" style="text-align:left;padding:12px 0">No analysis runs yet.</div>
          </div>
        </div>

        <!-- RESULTS -->
        <div id="tab-results">
          <div id="results-main">
            <div id="no-results" class="empty-state">No results yet. Run an analysis first.</div>
            <div id="results-content" style="display:none"></div>
          </div>
          <div id="results-sidebar">
            <div class="rs-header">
              <div class="rs-title">Themes & Codes</div>
              <input type="text" id="rs-search" placeholder="Search excerpts..." oninput="filterResults()">
            </div>
            <div class="rs-filters">
              <button class="rs-filter active" data-filter="all" onclick="setRsFilter(this)">All</button>
              <button class="rs-filter" data-filter="themes" onclick="setRsFilter(this)">Themes</button>
              <button class="rs-filter" data-filter="codes" onclick="setRsFilter(this)">Codes</button>
            </div>
            <div id="rs-list"></div>
          </div>
        </div>

        <!-- NOTES -->
        <div id="tab-notes">
          <div class="section-label">Researcher Notes & Reflexive Memo</div>
          <textarea id="notes-area" placeholder="Record your reflexive memos, analytical decisions, positionality notes, and observations here...&#10;&#10;This space is yours — think of it as your methodological diary."></textarea>
          <div class="notes-footer">
            <span class="notes-saved" id="notes-saved"></span>
            <button class="topbar-btn" onclick="saveNotes()">Save Notes</button>
          </div>
        </div>

      </div><!-- /tab-content -->

      <!-- EXPORT BAR -->
      <div class="export-bar" id="export-bar" style="display:none">
        <button class="topbar-btn" onclick="exportTXT()">Export TXT</button>
        <button class="topbar-btn" onclick="exportCSV()">Export CSV</button>
        <button class="topbar-btn" onclick="exportJSON()">Export JSON</button>
      </div>

    </div><!-- /project-view -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- LOADING -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-msg">Running analysis...</div>
  <div class="loading-steps">
    <div class="lstep" id="ls1">↳ Familiarisation with data</div>
    <div class="lstep" id="ls2">↳ Initial code generation</div>
    <div class="lstep" id="ls3">↳ Searching for themes</div>
    <div class="lstep" id="ls4">↳ Reviewing & refining themes</div>
    <div class="lstep" id="ls5">↳ Extracting supporting excerpts</div>
  </div>
</div>

<!-- MODAL: NEW/EDIT PROJECT -->
<div class="modal-overlay" id="modal-project">
  <div class="modal">
    <div class="modal-title" id="modal-project-title">New Project</div>
    <div class="form-row">
      <label class="form-label">Project Title *</label>
      <input type="text" id="proj-title-input" placeholder="e.g. Refugee Experience Study">
    </div>
    <div class="form-row">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="proj-desc-input" placeholder="Brief description of your study..."></textarea>
    </div>
    <div class="form-row">
      <label class="form-label">Research Question (optional)</label>
      <input type="text" id="proj-rq-input" placeholder="What is your main research question?">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-project')">Cancel</button>
      <button class="btn-confirm" onclick="saveProject()">Save Project</button>
    </div>
  </div>
</div>

<!-- MODAL: ADD DOCUMENT -->
<div class="modal-overlay" id="modal-doc">
  <div class="modal">
    <div class="modal-title">Add Document</div>
    <div class="form-row">
      <label class="form-label">Document Title *</label>
      <input type="text" id="doc-title-input" placeholder="e.g. Interview P01 - Maria Chen">
    </div>
    <div class="form-row">
      <label class="form-label">Source Type</label>
      <select id="doc-source-input">
        <option>Interview Transcript</option>
        <option>Focus Group Transcript</option>
        <option>Field Notes</option>
        <option>Open-ended Survey Responses</option>
        <option>Document / Archival Text</option>
        <option>Diary / Journal Entry</option>
        <option>Other</option>
      </select>
    </div>
    <div class="form-row">
      <label class="form-label">Text Content *</label>
      <textarea class="form-input" id="doc-text-input" style="min-height:160px" placeholder="Paste your qualitative data here..."></textarea>
    </div>
    <div style="margin-bottom:14px">
      <label class="form-label" style="display:block;margin-bottom:6px">Or upload .txt / .md file</label>
      <input type="file" id="doc-file-input" accept=".txt,.md" onchange="readDocFile(event)" style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted)">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-doc')">Cancel</button>
      <button class="btn-confirm" onclick="saveDoc()">Add Document</button>
    </div>
  </div>
</div>

<!-- MODAL: API KEY -->
<div class="modal-overlay" id="modal-api">
  <div class="modal">
    <div class="modal-title">Gemini API Key</div>
    <div class="form-row">
      <label class="form-label">API Key</label>
      <input type="password" id="api-key-input" placeholder="AIza...">
    </div>
    <div style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-dim);line-height:1.8;margin-bottom:16px">
      Get a free key at <span style="color:var(--accent2)">aistudio.google.com</span> → Get API Key.<br>
      Your key is stored only in your browser's localStorage.<br>
      It never leaves your device.
    </div>
    <div class="err-msg" id="api-err"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('modal-api')">Cancel</button>
      <button class="btn-confirm" onclick="saveApiKey()">Save Key</button>
    </div>
  </div>
</div>

<!-- MODAL: VIEW DOCUMENT -->
<div class="modal-overlay" id="modal-view-doc">
  <div class="modal" style="width:640px;max-width:95vw">
    <div class="modal-title" id="view-doc-title"></div>
    <div style="font-family:var(--font-body);font-size:0.82rem;line-height:1.8;color:var(--text-muted);max-height:400px;overflow-y:auto;white-space:pre-wrap;border:1px solid var(--border);padding:14px;background:var(--bg)" id="view-doc-text"></div>
    <div class="modal-actions">
      <button class="btn-confirm" onclick="closeModal('modal-view-doc')">Close</button>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let state = {
  projects: [],
  currentProjectId: null,
  editingProjectId: null,
  selectedMethod: 'reflexive_ta',
  categories: [],
  currentRunId: null,
  rsFilter: 'all'
};

const STORAGE_KEY = 'themelens_v2';

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) state = { ...state, ...JSON.parse(saved) };
  } catch(e) {}
}

function saveState() {
  const toSave = { projects: state.projects };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
}

function getProject() {
  return state.projects.find(p => p.id === state.currentProjectId);
}

function getApiKey() {
  return localStorage.getItem('tl_gemini_key') || '';
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
window.onload = () => {
  loadState();
  renderSidebar();
  updateApiStatus();
  const key = document.getElementById('api-key-input');
  const saved = getApiKey();
  if (saved) key.value = saved;
};

// ═══════════════════════════════════════════
// API KEY
// ═══════════════════════════════════════════
function openApiModal() { openModal('modal-api'); }

function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) return showErr('api-err', 'Please enter your API key.');
  if (!key.startsWith('AI')) return showErr('api-err', 'Key should start with "AI". Check aistudio.google.com.');
  localStorage.setItem('tl_gemini_key', key);
  updateApiStatus();
  closeModal('modal-api');
}

function updateApiStatus() {
  const key = getApiKey();
  const dot = document.getElementById('apiDot');
  const txt = document.getElementById('apiStatusText');
  if (key) {
    dot.className = 'ok';
    txt.textContent = 'API key configured';
  } else {
    dot.className = '';
    txt.textContent = 'No API key';
  }
}

// ═══════════════════════════════════════════
// PROJECTS
// ═══════════════════════════════════════════
function openNewProject() {
  state.editingProjectId = null;
  document.getElementById('modal-project-title').textContent = 'New Project';
  document.getElementById('proj-title-input').value = '';
  document.getElementById('proj-desc-input').value = '';
  document.getElementById('proj-rq-input').value = '';
  openModal('modal-project');
}

function editProject() {
  const p = getProject();
  if (!p) return;
  state.editingProjectId = p.id;
  document.getElementById('modal-project-title').textContent = 'Edit Project';
  document.getElementById('proj-title-input').value = p.title;
  document.getElementById('proj-desc-input').value = p.description || '';
  document.getElementById('proj-rq-input').value = p.researchQuestion || '';
  openModal('modal-project');
}

function saveProject() {
  const title = document.getElementById('proj-title-input').value.trim();
  if (!title) return alert('Project title is required.');

  if (state.editingProjectId) {
    const p = state.projects.find(p => p.id === state.editingProjectId);
    if (p) {
      p.title = title;
      p.description = document.getElementById('proj-desc-input').value.trim();
      p.researchQuestion = document.getElementById('proj-rq-input').value.trim();
    }
  } else {
    const proj = {
      id: 'proj_' + Date.now(),
      title,
      description: document.getElementById('proj-desc-input').value.trim(),
      researchQuestion: document.getElementById('proj-rq-input').value.trim(),
      status: 'active',
      created: new Date().toISOString(),
      documents: [],
      runs: [],
      notes: ''
    };
    state.projects.unshift(proj);
    state.currentProjectId = proj.id;
  }

  saveState();
  renderSidebar();
  closeModal('modal-project');
  if (!state.editingProjectId) openProjectView();
  else renderProjectHeader();
}

function archiveProject() {
  const p = getProject();
  if (!p) return;
  p.status = p.status === 'archived' ? 'active' : 'archived';
  saveState();
  renderSidebar();
  renderProjectHeader();
}

function deleteProject() {
  const p = getProject();
  if (!p) return;
  if (!confirm(`Delete "${p.title}"? This cannot be undone.`)) return;
  state.projects = state.projects.filter(pr => pr.id !== p.id);
  state.currentProjectId = null;
  saveState();
  renderSidebar();
  document.getElementById('project-view').style.display = 'none';
  document.getElementById('welcome').style.display = 'flex';
}

function renderSidebar() {
  const list = document.getElementById('projects-list');
  list.innerHTML = '';
  if (!state.projects.length) {
    list.innerHTML = '<div class="empty-state">No projects yet.<br>Create one to begin.</div>';
    return;
  }
  state.projects.forEach(p => {
    const el = document.createElement('div');
    el.className = 'project-item' + (p.id === state.currentProjectId ? ' active' : '');
    el.onclick = () => { state.currentProjectId = p.id; renderSidebar(); openProjectView(); };
    const docsCount = p.documents?.length || 0;
    const runsCount = p.runs?.length || 0;
    el.innerHTML = `
      <div class="proj-name">${escHtml(p.title)}</div>
      <div class="proj-meta">
        <span>${docsCount} doc${docsCount!==1?'s':''}</span>
        <span>${runsCount} run${runsCount!==1?'s':''}</span>
        <span class="proj-badge ${p.status}">${p.status}</span>
      </div>`;
    list.appendChild(el);
  });
}

function openProjectView() {
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('project-view').style.display = 'flex';
  document.getElementById('project-view').style.flexDirection = 'column';
  renderProjectHeader();
  switchTab('documents');
}

function renderProjectHeader() {
  const p = getProject();
  if (!p) return;
  document.getElementById('proj-title').textContent = p.title;
  document.getElementById('proj-desc').textContent = p.description || (p.researchQuestion ? 'RQ: ' + p.researchQuestion : '');
}

// ═══════════════════════════════════════════
// TABS
// ═══════════════════════════════════════════
function switchTab(name) {
  document.querySelectorAll('.proj-tab').forEach((t,i) => {
    const tabs = ['documents','analysis','results','notes'];
    t.classList.toggle('active', tabs[i] === name);
  });
  ['documents','analysis','results','notes'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    el.classList.toggle('active', t === name);
  });
  const exportBar = document.getElementById('export-bar');
  exportBar.style.display = name === 'results' ? 'flex' : 'none';
  if (name === 'documents') renderDocs();
  if (name === 'analysis') renderRuns();
  if (name === 'results') renderResults();
  if (name === 'notes') loadNotes();
}

// ═══════════════════════════════════════════
// DOCUMENTS
// ═══════════════════════════════════════════
function openAddDoc() { 
  document.getElementById('doc-title-input').value = '';
  document.getElementById('doc-text-input').value = '';
  document.getElementById('doc-source-input').selectedIndex = 0;
  openModal('modal-doc'); 
}

function readDocFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('doc-text-input').value = ev.target.result;
    if (!document.getElementById('doc-title-input').value) {
      document.getElementById('doc-title-input').value = file.name.replace(/\.[^.]+$/,'');
    }
  };
  reader.readAsText(file);
}

function saveDoc() {
  const title = document.getElementById('doc-title-input').value.trim();
  const text = document.getElementById('doc-text-input').value.trim();
  if (!title) return alert('Document title is required.');
  if (!text) return alert('Document text is required.');
  const p = getProject();
  if (!p) return;
  if (!p.documents) p.documents = [];
  p.documents.push({
    id: 'doc_' + Date.now(),
    title,
    source: document.getElementById('doc-source-input').value,
    text,
    added: new Date().toISOString()
  });
  saveState();
  renderSidebar();
  closeModal('modal-doc');
  renderDocs();
}

function renderDocs() {
  const p = getProject();
  if (!p) return;
  const tbody = document.getElementById('docs-tbody');
  const noDocs = document.getElementById('no-docs');
  const table = document.getElementById('docs-table');
  const docs = p.documents || [];
  if (!docs.length) {
    tbody.innerHTML = '';
    noDocs.style.display = 'block';
    table.style.display = 'none';
    return;
  }
  noDocs.style.display = 'none';
  table.style.display = 'table';
  tbody.innerHTML = docs.map(d => `
    <tr>
      <td class="doc-name">${escHtml(d.title)}</td>
      <td><span class="doc-source">${escHtml(d.source)}</span></td>
      <td class="doc-date">${fmtDate(d.added)}</td>
      <td>
        <div class="doc-actions">
          <button class="small-btn" onclick="viewDoc('${d.id}')">View</button>
          <button class="small-btn danger" onclick="deleteDoc('${d.id}')">Delete</button>
        </div>
      </td>
    </tr>`).join('');
}

function viewDoc(id) {
  const p = getProject();
  const doc = p?.documents?.find(d => d.id === id);
  if (!doc) return;
  document.getElementById('view-doc-title').textContent = doc.title;
  document.getElementById('view-doc-text').textContent = doc.text;
  openModal('modal-view-doc');
}

function deleteDoc(id) {
  if (!confirm('Delete this document?')) return;
  const p = getProject();
  p.documents = p.documents.filter(d => d.id !== id);
  saveState();
  renderSidebar();
  renderDocs();
}

// ═══════════════════════════════════════════
// METHODOLOGY
// ═══════════════════════════════════════════
function selectMethod(card) {
  document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  state.selectedMethod = card.dataset.method;
  document.getElementById('deductive-panel').style.display =
    state.selectedMethod === 'deductive_ta' ? 'block' : 'none';
}

function addCategory() {
  const input = document.getElementById('catInput');
  const val = input.value.trim();
  if (!val) return;
  if (!state.categories.includes(val)) state.categories.push(val);
  input.value = '';
  renderCategories();
}

function removeCategory(cat) {
  state.categories = state.categories.filter(c => c !== cat);
  renderCategories();
}

function renderCategories() {
  document.getElementById('categories-list').innerHTML = state.categories.map(c => `
    <span class="category-tag">${escHtml(c)}<button onclick="removeCategory('${escHtml(c)}')">&times;</button></span>
  `).join('');
}

// ═══════════════════════════════════════════
// ANALYSIS PROMPT BUILDER
// ═══════════════════════════════════════════
const METHOD_INFO = {
  reflexive_ta: { name: 'Reflexive Thematic Analysis (Braun & Clarke, 2022)', instruction: 'Apply the reflexive thematic analysis approach. The researcher plays an active role in theme construction. Be interpretive, not just descriptive. Themes should be conceptual patterns of shared meaning, not mere topics.' },
  inductive_ta: { name: 'Inductive Thematic Analysis (bottom-up)', instruction: 'Let themes emerge entirely from the data without applying any theoretical preconceptions. Do not import external frameworks. Codes and themes should be grounded purely in what the data says.' },
  deductive_ta: { name: 'Deductive Thematic Analysis (top-down)', instruction: 'Analyse the data using the predefined theoretical categories provided. Map data to these categories, identify how the data confirms, extends, or challenges them. You may identify sub-themes within each category.' },
  framework_ta: { name: 'Framework Analysis', instruction: 'Use a structured matrix-based approach. Identify a clear analytical framework from the data and chart the data systematically. Particularly note similarities and differences across cases/participants.' },
  content_analysis: { name: 'Content Analysis (Bardin, 1977)', instruction: 'Apply systematic content analysis. Identify manifest and latent content. Focus on categorisation, frequency of themes, and patterns. Be systematic and exhaustive in coverage.' },
  narrative: { name: 'Narrative Analysis', instruction: 'Analyse the narrative structure. How do participants construct their stories? Identify plot elements, turning points, narrative identities, and how the past is used to make sense of the present. Preserve narrative integrity.' }
};

function buildPrompt(text, method, lang, depth, categories) {
  const m = METHOD_INFO[method] || METHOD_INFO.reflexive_ta;
  const depthNote = depth === 'brief' ? 'Keep analysis concise: 2-3 themes maximum.' : depth === 'detailed' ? 'Be thorough and generate rich, detailed analysis with multiple subthemes and codes.' : 'Standard depth: balanced analysis.';
  const catNote = (method === 'deductive_ta' && categories.length) ? `\nPredefined categories to use as your framework: ${categories.join(', ')}\n` : '';

  return `You are an expert qualitative researcher applying ${m.name}.

${m.instruction}
${depthNote}
${catNote}
Respond ONLY in valid JSON. All text in the JSON must be in ${lang}.

INPUT DATA:
"""
${text}
"""

Return this exact JSON structure:
{
  "summary": "Overview of data and analytical focus (2-3 sentences)",
  "total_codes": <number>,
  "total_themes": <number>,
  "themes": [
    {
      "theme_id": 1,
      "theme_name": "Conceptual theme name",
      "theme_description": "What this theme captures and its significance (2-3 sentences)",
      "subthemes": [
        {
          "subtheme_id": "1.1",
          "subtheme_name": "Subtheme name",
          "subtheme_description": "What this subtheme captures",
          "codes": [
            {
              "code_id": "1.1.1",
              "code_label": "Short descriptive code",
              "code_description": "What this code captures in the data",
              "excerpts": [
                {
                  "text": "Verbatim quote from input text",
                  "relevance": "Why this excerpt supports the code"
                }
              ]
            }
          ]
        }
      ]
    }
  ],
  "analytical_memo": "Reflexive notes on patterns, tensions, analytical decisions, limitations (3-5 sentences)"
}

Rules: excerpts must be verbatim quotes; each code needs at least one excerpt; themes must be conceptual not merely topical.`;
}

// ═══════════════════════════════════════════
// RUN ANALYSIS
// ═══════════════════════════════════════════
async function runAnalysis() {
  const p = getProject();
  const key = getApiKey();
  const errEl = document.getElementById('analysis-err');
  errEl.classList.remove('visible');

  if (!key) return showErr('analysis-err', 'No API key configured. Click "API Key" in the top bar.');
  if (!p?.documents?.length) return showErr('analysis-err', 'No documents found. Add documents first in the Documents tab.');

  const lang = document.getElementById('opt-lang').value;
  const depth = document.getElementById('opt-depth').value;
  const combinedText = p.documents.map(d => `[${d.title}]\n${d.text}`).join('\n\n---\n\n');

  if (combinedText.length < 50) return showErr('analysis-err', 'Documents appear to be empty.');

  const prompt = buildPrompt(combinedText, state.selectedMethod, lang, depth, state.categories);

  // Show loading
  document.getElementById('loading-overlay').classList.add('visible');
  document.getElementById('run-btn').disabled = true;
  const steps = ['ls1','ls2','ls3','ls4','ls5'];
  let si = 0;
  const stepInt = setInterval(() => {
    if (si < steps.length) document.getElementById(steps[si++]).classList.add('active');
  }, 1400);

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.3, maxOutputTokens: 8192 }
      })
    });

    clearInterval(stepInt);
    steps.forEach(s => document.getElementById(s).classList.remove('active'));
    document.getElementById('loading-overlay').classList.remove('visible');
    document.getElementById('run-btn').disabled = false;

    if (!res.ok) {
      const err = await res.json();
      const msg = err.error?.message || `HTTP ${res.status}`;
      if (msg.includes('API_KEY') || res.status === 400) throw new Error('Invalid API key. Check aistudio.google.com.');
      if (res.status === 429) throw new Error('Rate limit reached. Wait a moment and try again.');
      throw new Error(msg);
    }

    const data = await res.json();
    const raw = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!raw) throw new Error('Empty response from API.');

    const clean = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    const analysis = JSON.parse(clean);

    const methodName = METHOD_INFO[state.selectedMethod]?.name || state.selectedMethod;
    const run = {
      id: 'run_' + Date.now(),
      method: methodName,
      methodKey: state.selectedMethod,
      language: lang,
      depth,
      docsCount: p.documents.length,
      categories: [...state.categories],
      timestamp: new Date().toISOString(),
      status: 'complete',
      analysis
    };

    if (!p.runs) p.runs = [];
    p.runs.unshift(run);
    state.currentRunId = run.id;
    saveState();
    renderSidebar();
    renderRuns();
    switchTab('results');

  } catch(err) {
    clearInterval(stepInt);
    steps.forEach(s => document.getElementById(s).classList.remove('active'));
    document.getElementById('loading-overlay').classList.remove('visible');
    document.getElementById('run-btn').disabled = false;

    let msg = err.message;
    if (msg.includes('JSON')) msg = 'Failed to parse AI response. Try again — may be temporary.';
    showErr('analysis-err', msg);
  }
}

// ═══════════════════════════════════════════
// RUNS
// ═══════════════════════════════════════════
function renderRuns() {
  const p = getProject();
  const list = document.getElementById('runs-list');
  const noRuns = document.getElementById('no-runs');
  const runs = p?.runs || [];
  if (!runs.length) { list.innerHTML = ''; noRuns.style.display = 'block'; return; }
  noRuns.style.display = 'none';
  list.innerHTML = runs.map((r,i) => `
    <div class="run-item ${r.id === state.currentRunId ? 'selected-run' : ''}" onclick="selectRun('${r.id}')">
      <div class="run-number">Run #${runs.length - i}</div>
      <div class="run-info">
        <div class="run-method">${escHtml(r.method)}</div>
        <div class="run-meta">${fmtDate(r.timestamp)} · ${r.docsCount} doc(s) · ${r.language}</div>
      </div>
      <span class="run-status ${r.status}">${r.status}</span>
      <div class="run-actions">
        <button class="small-btn" onclick="event.stopPropagation();viewRun('${r.id}')">View</button>
        <button class="small-btn danger" onclick="event.stopPropagation();deleteRun('${r.id}')">Del</button>
      </div>
    </div>`).join('');
}

function selectRun(id) {
  state.currentRunId = id;
  renderRuns();
  switchTab('results');
}

function viewRun(id) {
  state.currentRunId = id;
  switchTab('results');
}

function deleteRun(id) {
  if (!confirm('Delete this run?')) return;
  const p = getProject();
  p.runs = p.runs.filter(r => r.id !== id);
  if (state.currentRunId === id) state.currentRunId = p.runs[0]?.id || null;
  saveState();
  renderRuns();
  renderResults();
}

// ═══════════════════════════════════════════
// RESULTS
// ═══════════════════════════════════════════
function renderResults() {
  const p = getProject();
  const noResults = document.getElementById('no-results');
  const content = document.getElementById('results-content');
  const run = p?.runs?.find(r => r.id === state.currentRunId) || p?.runs?.[0];
  if (!run) { noResults.style.display = 'block'; content.style.display = 'none'; renderRsSidebar(null); return; }
  state.currentRunId = run.id;
  noResults.style.display = 'none';
  content.style.display = 'block';

  const a = run.analysis;
  let html = `
    <div class="results-stats fade-up">
      <div class="stat-item"><div class="stat-val">${a.total_themes || a.themes?.length || '—'}</div><div class="stat-lbl">Themes</div></div>
      <div class="stat-item"><div class="stat-val">${a.total_codes || '—'}</div><div class="stat-lbl">Codes</div></div>
      <div class="stat-item"><div class="stat-val">${run.docsCount}</div><div class="stat-lbl">Documents</div></div>
    </div>
    <div class="result-summary fade-up">${escHtml(a.summary)}</div>`;

  (a.themes || []).forEach((theme, ti) => {
    const subHtml = (theme.subthemes || []).map(sub => {
      const codesHtml = (sub.codes || []).map(code => {
        const exHtml = (code.excerpts || []).map(ex => `
          <div class="excerpt-item">
            <div class="excerpt-quote">"${escHtml(ex.text)}"</div>
            <div class="excerpt-rel">${escHtml(ex.relevance)}</div>
          </div>`).join('');
        return `
          <div class="code-block" onclick="toggleCode(this)">
            <div class="code-top">
              <span class="code-id-lbl">${escHtml(code.code_id)}</span>
              <span class="code-label">${escHtml(code.code_label)}</span>
            </div>
            <div class="code-desc">${escHtml(code.code_description)}</div>
            <div class="excerpts-toggle">▸ ${code.excerpts?.length||0} excerpt(s)</div>
            <div class="excerpts-wrap">${exHtml}</div>
          </div>`;
      }).join('');
      return `
        <div class="subtheme">
          <div class="sub-name"><span class="sub-id">${escHtml(sub.subtheme_id)}</span>${escHtml(sub.subtheme_name)}</div>
          <div class="sub-desc">${escHtml(sub.subtheme_description)}</div>
          ${codesHtml}
        </div>`;
    }).join('');

    html += `
      <div class="theme-card fade-up" id="theme-${ti}">
        <div class="theme-hdr" onclick="toggleTheme(this)">
          <div class="theme-num">0${ti+1}</div>
          <div class="theme-info">
            <div class="theme-name">${escHtml(theme.theme_name)}</div>
            <div class="theme-desc">${escHtml(theme.theme_description)}</div>
          </div>
          <div class="theme-chevron">▾</div>
        </div>
        <div class="theme-body">${subHtml}</div>
      </div>`;
  });

  if (a.analytical_memo) {
    html += `<div class="memo-card fade-up"><div class="memo-lbl">Analytical Memo</div><div class="memo-text">${escHtml(a.analytical_memo)}</div></div>`;
  }

  content.innerHTML = html;
  renderRsSidebar(run.analysis);
}

function toggleTheme(hdr) {
  const body = hdr.nextElementSibling;
  const chev = hdr.querySelector('.theme-chevron');
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

function toggleCode(block) {
  const wrap = block.querySelector('.excerpts-wrap');
  const toggle = block.querySelector('.excerpts-toggle');
  wrap.classList.toggle('open');
  block.classList.toggle('open');
  const count = block.querySelectorAll('.excerpt-item').length;
  toggle.textContent = wrap.classList.contains('open') ? `▾ ${count} excerpt(s)` : `▸ ${count} excerpt(s)`;
}

// ═══════════════════════════════════════════
// RESULTS SIDEBAR
// ═══════════════════════════════════════════
function renderRsSidebar(analysis) {
  const list = document.getElementById('rs-list');
  if (!analysis) { list.innerHTML = ''; return; }
  list.innerHTML = '';
  const filter = state.rsFilter;
  const search = document.getElementById('rs-search').value.toLowerCase();

  (analysis.themes || []).forEach((theme, ti) => {
    if (filter !== 'codes') {
      const div = document.createElement('div');
      div.className = 'rs-item';
      div.innerHTML = `<div class="rs-item-theme">Theme ${ti+1}</div><div class="rs-item-name">${escHtml(theme.theme_name)}</div>`;
      div.onclick = () => scrollToTheme(ti);
      if (!search || theme.theme_name.toLowerCase().includes(search)) list.appendChild(div);
    }
    if (filter !== 'themes') {
      (theme.subthemes || []).forEach(sub => {
        (sub.codes || []).forEach(code => {
          const ex = code.excerpts?.[0];
          if (search && !code.code_label.toLowerCase().includes(search) && !ex?.text.toLowerCase().includes(search)) return;
          const div = document.createElement('div');
          div.className = 'rs-item';
          div.innerHTML = `
            <div class="rs-item-theme">${escHtml(theme.theme_name)} › ${escHtml(sub.subtheme_name)}</div>
            <div class="rs-item-name" style="color:var(--accent3)">${escHtml(code.code_label)}</div>
            ${ex ? `<div class="rs-item-excerpt">"${escHtml(ex.text)}"</div>` : ''}`;
          list.appendChild(div);
        });
      });
    }
  });
}

function setRsFilter(btn) {
  document.querySelectorAll('.rs-filter').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  state.rsFilter = btn.dataset.filter;
  const p = getProject();
  const run = p?.runs?.find(r => r.id === state.currentRunId);
  renderRsSidebar(run?.analysis || null);
}

function filterResults() {
  const p = getProject();
  const run = p?.runs?.find(r => r.id === state.currentRunId);
  renderRsSidebar(run?.analysis || null);
}

function scrollToTheme(idx) {
  const el = document.getElementById('theme-' + idx);
  if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); el.classList.add('highlighted'); setTimeout(() => el.classList.remove('highlighted'), 2000); }
}

// ═══════════════════════════════════════════
// NOTES
// ═══════════════════════════════════════════
function loadNotes() {
  const p = getProject();
  document.getElementById('notes-area').value = p?.notes || '';
  document.getElementById('notes-saved').textContent = '';
}

function saveNotes() {
  const p = getProject();
  if (!p) return;
  p.notes = document.getElementById('notes-area').value;
  saveState();
  document.getElementById('notes-saved').textContent = 'Saved · ' + new Date().toLocaleTimeString();
}

// Auto-save notes
let notesTimer;
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('notes-area')?.addEventListener('input', () => {
    clearTimeout(notesTimer);
    notesTimer = setTimeout(saveNotes, 1500);
  });
});

// ═══════════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════════
function getCurrentAnalysis() {
  const p = getProject();
  return p?.runs?.find(r => r.id === state.currentRunId)?.analysis || p?.runs?.[0]?.analysis;
}

function exportTXT() {
  const a = getCurrentAnalysis();
  const p = getProject();
  if (!a) return alert('No analysis to export.');
  let txt = `THEMELENS — QUALITATIVE ANALYSIS REPORT\n${'═'.repeat(50)}\n\nProject: ${p.title}\n${p.description ? 'Description: ' + p.description + '\n' : ''}Date: ${new Date().toLocaleDateString()}\n\n${'─'.repeat(50)}\n\nSUMMARY\n${a.summary}\n\nThemes: ${a.total_themes} | Codes: ${a.total_codes}\n\n${'═'.repeat(50)}\n\n`;
  (a.themes||[]).forEach((t,i) => {
    txt += `THEME ${i+1}: ${t.theme_name}\n${t.theme_description}\n\n`;
    (t.subthemes||[]).forEach(s => {
      txt += `  ${s.subtheme_id} ${s.subtheme_name}\n  ${s.subtheme_description}\n\n`;
      (s.codes||[]).forEach(c => {
        txt += `    [${c.code_id}] ${c.code_label}\n    ${c.code_description}\n`;
        (c.excerpts||[]).forEach(e => txt += `      → "${e.text}"\n        (${e.relevance})\n`);
        txt += '\n';
      });
    });
    txt += '─'.repeat(50) + '\n\n';
  });
  if (a.analytical_memo) txt += `ANALYTICAL MEMO\n${a.analytical_memo}\n`;
  if (p.notes) txt += `\nRESEARCHER NOTES\n${p.notes}\n`;
  download(new Blob([txt], {type:'text/plain;charset=utf-8'}), 'themelens_report.txt');
}

function exportCSV() {
  const a = getCurrentAnalysis();
  if (!a) return alert('No analysis to export.');
  let rows = [['Theme ID','Theme','Subtheme ID','Subtheme','Code ID','Code','Code Description','Excerpt','Relevance']];
  (a.themes||[]).forEach(t => (t.subthemes||[]).forEach(s => (s.codes||[]).forEach(c => (c.excerpts||[]).forEach(e => {
    rows.push([t.theme_id, t.theme_name, s.subtheme_id, s.subtheme_name, c.code_id, c.code_label, c.code_description, e.text, e.relevance]);
  }))));
  const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download(new Blob([csv], {type:'text/csv;charset=utf-8'}), 'themelens_codes.csv');
}

function exportJSON() {
  const a = getCurrentAnalysis();
  const p = getProject();
  if (!a) return alert('No analysis to export.');
  const out = { project: p.title, description: p.description, exported: new Date().toISOString(), analysis: a };
  download(new Blob([JSON.stringify(out,null,2)], {type:'application/json'}), 'themelens_analysis.json');
}

function download(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('visible'); }
function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
function showErr(id, msg) { const el = document.getElementById(id); el.textContent = '✗ ' + msg; el.classList.add('visible'); }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtDate(iso) { try { return new Date(iso).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); } catch(e) { return iso; } }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('visible'); });
});
</script>
</body>
</html>
